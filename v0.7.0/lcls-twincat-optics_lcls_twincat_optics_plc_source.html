<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-optics  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/tree.css?v=837a00b9" />
      <link rel="stylesheet" type="text/css" href="_static/width.css?v=ab210c7a" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="lcls-twincat-optics_lcls_twincat_optics_plc_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-twincat-optics
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">lcls-twincat-optics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_ethercat.html">EtherCAT Terminals</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">lcls_twincat_optics_plc</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-optics_lcls_twincat_optics_plc_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dut-homs">DUT_HOMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-piezocontrol">E_PiezoControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-pitchcontrol">E_PitchControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#homs-pitchmechanism">HOMS_PitchMechanism</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-piezoaxis">ST_PiezoAxis</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#global-version">Global_Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-constants">GVL_Constants</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gvl-teststructs">GVL_TestStructs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fb-axilon-cooling-1f1p">FB_Axilon_Cooling_1f1p</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-axilon-cooling-2f1p">FB_Axilon_Cooling_2f1p</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-bender">FB_Bender</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-homsstats">FB_HomsStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-mirrortwocoatingprotection">FB_MirrorTwoCoatingProtection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pi-e621-serialdriver">FB_PI_E621_SerialDriver</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pi-e621-serialtransaction">FB_PI_E621_SerialTransaction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-piezocontrol">FB_PiezoControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pitchcontrol">FB_PitchControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-rmswatch">FB_RMSWatch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-runhoms">FB_RunHOMS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#main">Main</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mc-smoothmover">MC_SmoothMover</a></li>
<li class="toctree-l2"><a class="reference internal" href="#test-pitchcontrol">TEST_PitchControl</a></li>
<li class="toctree-l2"><a class="reference internal" href="#withinrange">WithinRange</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-optics</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/lcls-twincat-optics_lcls_twincat_optics_plc_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="dut-homs">
<h2>DUT_HOMS<a class="headerlink" href="#dut-homs" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">DUT_HOMS</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="o">//</span> <span class="n">System</span> <span class="n">initializiation</span>
    <span class="n">fbRunHOMS</span> <span class="p">:</span> <span class="n">FB_RunHOMS</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Couple</span><span class="o">/</span><span class="n">Decouple</span> <span class="n">motors</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">COUPLE_Y</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecuteCoupleY</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DECOUPLE_Y</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecuteDecoupleY</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">COUPLE_X</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecuteCoupleX</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">DECOUPLE_X</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">o</span>
    <span class="s1">&#39;}</span>
    <span class="n">bExecuteDecoupleX</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Coupling</span> <span class="n">status</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ALREADY_COUPLED_Y</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZSV</span> <span class="n">MAJOR</span>
    <span class="s1">&#39;}</span>
    <span class="n">bGantryAlreadyCoupledY</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ALREADY_COUPLED_X</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZSV</span> <span class="n">MAJOR</span>
    <span class="s1">&#39;}</span>
    <span class="n">bGantryAlreadyCoupledX</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Current</span> <span class="n">gantry</span> <span class="n">differences</span>
    <span class="n">nCurrGantryY</span> <span class="p">:</span> <span class="n">LINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>
    <span class="n">nCurrGantryX</span> <span class="p">:</span> <span class="n">LINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>

    <span class="o">//</span> <span class="n">Convert</span> <span class="n">gantry</span> <span class="n">differences</span> <span class="n">to</span> <span class="n">um</span> <span class="p">(</span><span class="n">smaller</span> <span class="n">number</span><span class="p">)</span> <span class="n">to</span> <span class="n">readout</span> <span class="ow">in</span> <span class="n">epics</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GANTRY_Y</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">um</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCurrGantryY_um</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Y</span> <span class="n">Gantry</span> <span class="n">difference</span> <span class="ow">in</span> <span class="n">um</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GANTRY_X</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">um</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCurrGantryX_um</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span> <span class="n">X</span> <span class="n">Gantry</span> <span class="n">difference</span> <span class="ow">in</span> <span class="n">um</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-homs">DUT_HOMS</a></p></li>
<li><p><a class="reference internal" href="#fb-runhoms">FB_RunHOMS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-piezocontrol">
<h2>E_PiezoControl<a class="headerlink" href="#e-piezocontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">E_PiezoControl</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="o">//</span><span class="n">Piezo</span> <span class="n">Control</span> <span class="n">Machine</span>
    <span class="n">EPC_Idle</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">EPC_Init</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">EPC_MoveRequested</span>  <span class="o">:=</span> <span class="mi">50</span><span class="p">,</span>
    <span class="n">EPC_MovingPositive</span> <span class="o">:=</span> <span class="mi">100</span><span class="p">,</span>
    <span class="n">EPC_MovingNegative</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">EPC_MoveCompleted</span>  <span class="o">:=</span> <span class="mi">350</span><span class="p">,</span>
    <span class="n">EPC_Error</span> <span class="o">:=</span> <span class="mi">500</span>
<span class="p">);</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-pitchcontrol">
<h2>E_PitchControl<a class="headerlink" href="#e-pitchcontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>TYPE E_PitchControl :
(
    //Pitch Control Machine
    PCM_Init := 0,
    PCM_Standby := 1,
    PCM_MoveRequested := 10,
    PCM_Coarse50Piezo       := 20,
    PCM_CoarseMove  := 21,
    PCM_CoarseMoveCleanup := 22,
    PCM_FineMove    := 30,
    PCM_Halt                := 50,
    PCM_Done        := 8000, //why is 8000 done? Where did this come from??
    PCM_Error   := 9000, //Anything above 9000 is considered an error
    PCM_StepperError        := 9100,
    PCM_PiezoError  := 9200,
    PCM_OtherError := 9300,
    PCM_STOHit := 9400
);
END_TYPE
</pre></div>
</div>
</section>
<section id="homs-pitchmechanism">
<h2>HOMS_PitchMechanism<a class="headerlink" href="#homs-pitchmechanism" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">HOMS_PitchMechanism</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="n">Piezo</span>   <span class="p">:</span>       <span class="n">ST_PiezoAxis</span><span class="p">;</span>   <span class="o">//</span><span class="n">Piezo</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Soft</span> <span class="n">limits</span><span class="p">,</span> <span class="n">egu</span> <span class="n">urad</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">ReqPosLimHi</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>
    <span class="n">ReqPosLimLo</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">Hard</span> <span class="n">limits</span><span class="p">,</span> <span class="n">egu</span> <span class="n">INC</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">These</span> <span class="n">are</span> <span class="n">discovered</span> <span class="n">during</span> <span class="n">installation</span><span class="p">,</span> <span class="ow">and</span> <span class="n">represent</span> <span class="n">encoder</span> <span class="n">ticks</span><span class="p">,</span> <span class="n">unbiased</span> <span class="o">*</span><span class="p">)</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">We</span> <span class="n">changed</span> <span class="n">to</span> <span class="n">these</span> <span class="n">when</span> <span class="n">our</span> <span class="n">pitch</span> <span class="n">mechanism</span> <span class="n">limit</span> <span class="n">switches</span> <span class="n">were</span> <span class="n">insufficient</span> <span class="k">for</span>
    <span class="n">good</span> <span class="n">control</span><span class="o">.</span> <span class="n">They</span> <span class="n">had</span> <span class="n">too</span> <span class="n">much</span> <span class="n">hysteresis</span><span class="o">/</span> <span class="n">lack</span> <span class="n">of</span> <span class="n">precision</span><span class="o">.</span> <span class="n">At</span> <span class="n">this</span> <span class="n">point</span> <span class="n">the</span> <span class="n">limit</span>
    <span class="n">switches</span> <span class="n">are</span> <span class="n">ignored</span><span class="p">,</span> <span class="ow">and</span> <span class="n">instead</span> <span class="n">their</span> <span class="n">function</span> <span class="ow">is</span> <span class="n">carried</span> <span class="n">out</span> <span class="n">by</span> <span class="n">these</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">diEncPosLimHi</span>   <span class="p">:</span>       <span class="n">LINT</span><span class="p">;</span>
    <span class="n">diEncPosLimLo</span>   <span class="p">:</span>       <span class="n">LINT</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Raw</span> <span class="n">encoder</span> <span class="n">count</span>
    <span class="n">diEncCnt</span>        <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span>  <span class="p">:</span>       <span class="n">LINT</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#st-piezoaxis">ST_PiezoAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="st-piezoaxis">
<h2>ST_PiezoAxis<a class="headerlink" href="#st-piezoaxis" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_PiezoAxis</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">IO</span> <span class="o">*</span><span class="p">)</span>
        <span class="o">//</span><span class="n">Readback</span>
        <span class="n">sIdn</span>                                <span class="p">:</span>       <span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">Identity</span>
        <span class="n">iCurError</span>                   <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Current</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="n">should</span> <span class="n">be</span> <span class="mi">0</span> <span class="n">most</span> <span class="n">of</span> <span class="n">the</span> <span class="n">time</span>
        <span class="n">iLastError</span>                  <span class="p">:</span>       <span class="n">INT</span><span class="p">;</span> <span class="o">//</span><span class="n">Last</span> <span class="n">error</span> <span class="n">code</span><span class="p">,</span> <span class="k">for</span> <span class="n">history</span>
        <span class="n">rActVoltage</span>                 <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Actual</span> <span class="n">voltage</span>
        <span class="n">rLastReqVoltage</span>             <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Last</span> <span class="n">requested</span> <span class="n">piezo</span> <span class="n">voltage</span>
        <span class="o">//</span><span class="n">Control</span>
        <span class="n">rSetVoltage</span>                 <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">this</span> <span class="n">parameter</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">by</span> <span class="n">the</span> <span class="n">control</span> <span class="n">loop</span><span class="o">/</span> <span class="n">voltage</span> <span class="n">mode</span>
        <span class="n">sAxis</span>                               <span class="p">:</span>   <span class="n">STRING</span> <span class="o">:=</span><span class="s1">&#39;A&#39;</span><span class="p">;</span> <span class="o">//</span><span class="n">Axis</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="o">...</span><span class="n">A</span> <span class="k">if</span> <span class="n">single</span> <span class="n">unit</span>
        <span class="o">//</span><span class="n">Summaries</span>
        <span class="n">xTimeout</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
        <span class="n">xDriverError</span>                <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Summary</span> <span class="n">of</span> <span class="nb">any</span> <span class="n">driver</span> <span class="n">errors</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Operation</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">xEnable</span>     <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Enable</span> <span class="n">control</span><span class="o">.</span>
        <span class="p">(</span><span class="o">*</span> <span class="n">Note</span><span class="p">:</span> <span class="n">Voltage</span> <span class="n">mode</span> <span class="ow">and</span> <span class="n">Idle</span> <span class="n">mode</span> <span class="n">overrides</span> <span class="s2">&quot;DirectPiezoMode&quot;</span> <span class="n">of</span> <span class="n">FB_PitchControl</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">xVoltageMode</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Voltage</span> <span class="n">mode</span> <span class="n">gives</span> <span class="n">direct</span> <span class="n">access</span> <span class="n">to</span> <span class="n">piezo</span> <span class="n">voltage</span><span class="p">,</span> <span class="n">false</span> <span class="n">means</span> <span class="n">closed</span> <span class="n">loop</span> <span class="n">position</span> <span class="n">acquisition</span> <span class="p">(</span><span class="n">see</span> <span class="n">FB_PitchControl</span> <span class="k">for</span> <span class="n">piezo</span> <span class="ow">and</span> <span class="n">stepper</span> <span class="n">separation</span><span class="p">)</span>
        <span class="n">xIdleMode</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Use</span> <span class="n">to</span> <span class="n">put</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">at</span> <span class="n">half</span><span class="o">-</span><span class="n">stroke</span>
        <span class="n">rReqVoltage</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">piezo</span> <span class="n">voltage</span> <span class="ow">in</span> <span class="n">voltage</span> <span class="n">mode</span>
        <span class="n">rReqAbsPos</span>  <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Requested</span> <span class="n">Position</span><span class="p">,</span> <span class="n">latched</span> <span class="n">at</span> <span class="n">rising</span> <span class="n">StartAbsMov</span>
        <span class="n">xStop</span>       <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Stops</span> <span class="n">piezo</span> <span class="ow">and</span> <span class="n">holds</span> <span class="n">position</span>


    <span class="p">(</span><span class="o">*</span> <span class="n">Control</span> <span class="n">Parameters</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">rActPos</span>     <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Encoder</span> <span class="n">Readback</span>
        <span class="o">//</span><span class="n">Pitch</span> <span class="n">piezo</span> <span class="n">dmove</span> <span class="nb">range</span> <span class="p">(</span><span class="n">urad</span><span class="p">)</span>
        <span class="n">rPiezoDmovRange</span>             <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
        <span class="n">stPIParams</span>  <span class="p">:</span>       <span class="n">ST_CTRL_PI_PARAMS</span> <span class="o">:=</span> <span class="p">(</span>
            <span class="n">tCtrlCycleTime</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#0MS,</span>
            <span class="n">tTaskCycleTime</span> <span class="o">:=</span> <span class="n">T</span><span class="c1">#0MS,</span>
            <span class="n">tTn</span>       <span class="o">:=</span> <span class="n">T</span><span class="c1">#200MS,</span>
            <span class="n">fKp</span>      <span class="o">:=</span> <span class="mf">0.0005</span><span class="p">,</span>
            <span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">bARWOnIPartOnly</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">);</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">Voltage</span> <span class="n">ranges</span><span class="p">,</span> <span class="n">come</span> <span class="kn">from</span> <span class="nn">specifications</span> <span class="n">of</span> <span class="n">the</span> <span class="n">driver</span> <span class="o">*</span><span class="p">)</span>
        <span class="n">UpperVoltage</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="n">GVL_Constants</span><span class="o">.</span><span class="n">cPiezoMaxVoltage</span><span class="p">;</span> <span class="o">//</span> <span class="n">E</span><span class="o">-</span><span class="mi">816</span> <span class="n">has</span> <span class="n">no</span> <span class="n">software</span> <span class="n">limits</span>
        <span class="n">LowerVoltage</span>        <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="n">GVL_Constants</span><span class="o">.</span><span class="n">cPiezoMinVoltage</span><span class="p">;</span> <span class="o">//</span> <span class="n">E</span><span class="o">-</span><span class="mi">816</span> <span class="n">has</span> <span class="n">no</span> <span class="n">software</span> <span class="n">limits</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-pitchcontrol">FB_PitchControl</a></p></li>
<li><p><a class="reference internal" href="#gvl-constants">GVL_Constants</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="global-version">
<h2>Global_Version<a class="headerlink" href="#global-version" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcGenerated&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">automatically</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">project</span> <span class="n">information</span><span class="o">.</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;const_non_replaced&#39;</span><span class="p">}</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;linkalways&#39;</span><span class="p">}</span>
    <span class="n">stLibVersion_lcls_twincat_optics</span> <span class="p">:</span> <span class="n">ST_LibVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iMajor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iMinor</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">,</span> <span class="n">iBuild</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iRevision</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sVersion</span> <span class="o">:=</span> <span class="s1">&#39;0.7.0&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-constants">
<h2>GVL_Constants<a class="headerlink" href="#gvl-constants" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="n">nGANTRY_TOLERANCE_NM_DEFAULT</span> <span class="p">:</span> <span class="n">LINT</span> <span class="o">:=</span> <span class="mi">50000</span><span class="p">;</span> <span class="o">//</span> <span class="n">default</span> <span class="n">gantry</span> <span class="n">tolerance</span> <span class="ow">in</span> <span class="n">encoder</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">nm</span>
    <span class="n">cPiezoMaxVoltage</span>        <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">120</span><span class="p">;</span> <span class="o">//</span> <span class="ow">in</span> <span class="n">Volts</span>
    <span class="n">cPiezoMinVoltage</span>        <span class="p">:</span>       <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span> <span class="o">//</span> <span class="ow">in</span> <span class="n">Volts</span>
    <span class="n">cPiezoRange</span> <span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mf">60.0</span><span class="p">;</span> <span class="o">//</span> <span class="n">From</span> <span class="n">Old</span> <span class="n">HOMS_FEE</span> <span class="n">Project</span><span class="p">,</span> <span class="mi">90</span> <span class="n">um</span> <span class="n">of</span> <span class="n">piezo</span> <span class="n">stroke</span><span class="p">,</span> <span class="n">unsure</span> <span class="n">what</span> <span class="n">these</span> <span class="n">units</span> <span class="n">are</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
<section id="gvl-teststructs">
<h2>GVL_TestStructs<a class="headerlink" href="#gvl-teststructs" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">VAR_GLOBAL</span>
    <span class="n">TestPitch_LimitSwitches</span> <span class="p">:</span> <span class="n">HOMS_PitchMechanism</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqPosLimHi</span><span class="o">:=</span><span class="mi">2000</span><span class="p">,</span>
                                                      <span class="n">ReqPosLimLo</span><span class="o">:=-</span><span class="mi">2000</span><span class="p">,</span>
                                                      <span class="n">diEncPosLimHi</span><span class="o">:=</span><span class="mi">10768330</span><span class="p">,</span>
                                                      <span class="n">diEncPosLimLo</span><span class="o">:=</span><span class="mi">8141680</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#homs-pitchmechanism">HOMS_PitchMechanism</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="fb-axilon-cooling-1f1p">
<h2>FB_Axilon_Cooling_1f1p<a class="headerlink" href="#fb-axilon-cooling-1f1p" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Axilon_Cooling_1f1p</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">Mirrors</span> <span class="k">with</span> <span class="mi">1</span> <span class="n">Cooling</span> <span class="n">Flow</span> <span class="n">Meter</span> <span class="ow">and</span> <span class="mi">1</span> <span class="n">Pressure</span> <span class="n">Meter</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FWM</span><span class="p">:</span><span class="mi">1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">lpm</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HIGH</span> <span class="mf">2.3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HIHI</span> <span class="mf">3.0</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LOW</span> <span class="mf">1.7</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LOLO</span> <span class="mf">1.5</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LSV</span> <span class="n">MINOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LLSV</span> <span class="n">MAJOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HSV</span> <span class="n">MINOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HHSV</span> <span class="n">MAJOR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fFlow_1_val</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PRSM</span><span class="p">:</span><span class="mi">1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">bar</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LOW</span> <span class="mf">0.1</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LSV</span> <span class="n">MAJOR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fPress_1_val</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbFlow_1</span> <span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
    <span class="n">fbPress_1</span> <span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbFlow_1</span><span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mf">5.0427</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mf">0.050472</span><span class="p">);</span>
<span class="n">fFlow_1_val</span> <span class="o">:=</span> <span class="n">fbFlow_1</span><span class="o">.</span><span class="n">fReal</span><span class="p">;</span>

<span class="n">fbPress_1</span><span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mf">4.0</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">fPress_1_val</span> <span class="o">:=</span> <span class="n">fbPress_1</span><span class="o">.</span><span class="n">fReal</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-axilon-cooling-2f1p">
<h2>FB_Axilon_Cooling_2f1p<a class="headerlink" href="#fb-axilon-cooling-2f1p" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Axilon_Cooling_2f1p</span> <span class="n">EXTENDS</span> <span class="n">FB_Axilon_Cooling_1f1p</span>
<span class="o">//</span> <span class="n">Mirrors</span> <span class="k">with</span> <span class="mi">2</span> <span class="n">Cooling</span> <span class="n">Flow</span> <span class="n">Meters</span> <span class="ow">and</span> <span class="mi">1</span> <span class="n">Pressure</span> <span class="n">Meter</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FWM</span><span class="p">:</span><span class="mi">2</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">lpm</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HIGH</span> <span class="mf">2.3</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HIHI</span> <span class="mf">3.0</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LOW</span> <span class="mf">1.7</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LOLO</span> <span class="mf">1.5</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LSV</span> <span class="n">MINOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">LLSV</span> <span class="n">MAJOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HSV</span> <span class="n">MINOR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">HHSV</span> <span class="n">MAJOR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fFlow_2_val</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbFlow_2</span> <span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbFlow_2</span><span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mf">5.0427</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mf">0.050472</span><span class="p">);</span>
<span class="n">fFlow_2_val</span> <span class="o">:=</span> <span class="n">fbFlow_2</span><span class="o">.</span><span class="n">fReal</span><span class="p">;</span>

<span class="n">SUPER</span><span class="o">^</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-axilon-cooling-1f1p">FB_Axilon_Cooling_1f1p</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-bender">
<h2>FB_Bender<a class="headerlink" href="#fb-bender" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_Bender</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stBender</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">bSTOEnable1</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSTOEnable2</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Simple</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">tie</span> <span class="n">stBender</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">to</span> <span class="n">STO</span>
<span class="o">//</span> <span class="n">Originally</span> <span class="n">part</span> <span class="n">of</span> <span class="n">FB_RunHOMS</span><span class="p">,</span> <span class="n">but</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="n">this</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">systems</span><span class="p">,</span> <span class="ow">not</span> <span class="nb">all</span> <span class="n">of</span> <span class="n">which</span> <span class="n">have</span> <span class="n">a</span> <span class="n">bender</span> <span class="n">motor</span>
<span class="n">stBender</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">bSTOEnable1</span> <span class="n">AND</span> <span class="n">bSTOEnable2</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-runhoms">FB_RunHOMS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-homsstats">
<h2>FB_HomsStats<a class="headerlink" href="#fb-homsstats" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_HomsStats</span>
<span class="n">VAR_INPUT</span>
    <span class="n">homs</span> <span class="p">:</span> <span class="n">DUT_HOMS</span><span class="p">;</span>
    <span class="n">fbUpStreamY</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">fbUpStreamX</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fEncYScale</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fEncXScale</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fbDataYGantryDiff</span> <span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span> <span class="o">//</span> <span class="n">YGantry</span> <span class="n">Data</span> <span class="n">Acquisition</span> <span class="n">FB</span>
    <span class="n">fbDataXGantryDiff</span> <span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span> <span class="o">//</span> <span class="n">XGantry</span> <span class="n">Data</span> <span class="n">Acquisition</span> <span class="n">FB</span>

    <span class="n">fbYGantryStats</span> <span class="p">:</span> <span class="n">FB_BasicStats</span><span class="p">;</span> <span class="o">//</span> <span class="n">Calculate</span> <span class="n">mean</span><span class="o">/</span><span class="n">standard</span> <span class="n">deviation</span> <span class="n">of</span> <span class="n">YGantryDiff</span>
    <span class="n">fbXGantryStats</span> <span class="p">:</span> <span class="n">FB_BasicStats</span><span class="p">;</span> <span class="o">//</span> <span class="n">Calculate</span> <span class="n">mean</span><span class="o">/</span><span class="n">standard</span> <span class="n">deviation</span> <span class="n">of</span> <span class="n">XGantryDiff</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">YGANDIFFMEAN</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fYGantryDiffMean</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">YGANDIFFSTDEV</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fYGantryDiffStDev</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
        <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">XGANDIFFMEAN</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fXGantryDiffMean</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">XGANDIFFSTDEV</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fXGantryDiffStDev</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">bNewEncArray</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">YGANDIFFARRAY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">aYGantryDiff</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">XGANDIFFARRAY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">aXGantryDiff</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Ecn</span> <span class="n">scale</span> <span class="k">for</span> <span class="n">end</span> <span class="n">result</span> <span class="n">stats</span>
<span class="n">fEncYScale</span> <span class="o">:=</span> <span class="n">fbUpStreamY</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorNumerator</span> <span class="o">/</span> <span class="n">fbUpstreamY</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorDenominator</span><span class="p">;</span>
<span class="n">fEncXScale</span> <span class="o">:=</span> <span class="n">fbUpStreamX</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorNumerator</span> <span class="o">/</span> <span class="n">fbUpstreamX</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorDenominator</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Gantry</span> <span class="n">Diff</span> <span class="n">Readback</span><span class="o">/</span><span class="n">Storage</span>
<span class="n">fbDataYGantryDiff</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fInput</span><span class="o">:=</span> <span class="n">LINT_TO_LREAL</span><span class="p">(</span><span class="n">homs</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">),</span>
                <span class="n">arrOutput</span><span class="o">=&gt;</span><span class="n">aYGantryDiff</span><span class="p">,</span>
             <span class="n">bNewArray</span><span class="o">=&gt;</span><span class="n">bNewEncArray</span><span class="p">);</span>

<span class="n">fbDataXGantryDiff</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fInput</span><span class="o">:=</span> <span class="n">LINT_TO_LREAL</span><span class="p">(</span><span class="n">homs</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">),</span>
                <span class="n">arrOutput</span><span class="o">=&gt;</span><span class="n">aXGantryDiff</span><span class="p">,</span>
             <span class="n">bNewArray</span><span class="o">=&gt;</span><span class="n">bNewEncArray</span><span class="p">);</span>

<span class="n">fbYGantryStats</span><span class="p">(</span><span class="n">aSignal</span><span class="o">:=</span><span class="n">aYGantryDiff</span><span class="p">,</span>
        <span class="n">bAlwaysCalc</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">fMean</span><span class="o">=&gt;</span><span class="n">fYGantryDiffMean</span><span class="p">,</span>
        <span class="n">fStDev</span><span class="o">=&gt;</span><span class="n">fYGantryDiffStDev</span><span class="p">);</span>

<span class="n">fbXGantryStats</span><span class="p">(</span><span class="n">aSignal</span><span class="o">:=</span><span class="n">aXGantryDiff</span><span class="p">,</span>
        <span class="n">bAlwaysCalc</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">fMean</span><span class="o">=&gt;</span><span class="n">fXGantryDiffMean</span><span class="p">,</span>
        <span class="n">fStDev</span><span class="o">=&gt;</span><span class="n">fXGantryDiffStDev</span><span class="p">);</span>

<span class="o">//</span><span class="n">scale</span> <span class="n">outputs</span> <span class="n">to</span> <span class="n">actual</span> <span class="n">values</span>
<span class="n">fYGantryDiffMean</span> <span class="o">:=</span> <span class="n">fbYGantryStats</span><span class="o">.</span><span class="n">fMean</span> <span class="o">*</span> <span class="n">fEncYScale</span><span class="p">;</span>
<span class="n">fYGantryDiffStDev</span> <span class="o">:=</span> <span class="n">fbYGantryStats</span><span class="o">.</span><span class="n">fStDev</span> <span class="o">*</span> <span class="n">fEncYScale</span><span class="p">;</span>
<span class="n">fXGantryDiffMean</span> <span class="o">:=</span> <span class="n">fbXGantryStats</span><span class="o">.</span><span class="n">fMean</span> <span class="o">*</span> <span class="n">fEncXScale</span><span class="p">;</span>
<span class="n">fXGantryDiffStDev</span> <span class="o">:=</span> <span class="n">fbXGantryStats</span><span class="o">.</span><span class="n">fStDev</span> <span class="o">*</span> <span class="n">fEncXScale</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-homs">DUT_HOMS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-mirrortwocoatingprotection">
<h2>FB_MirrorTwoCoatingProtection<a class="headerlink" href="#fb-mirrortwocoatingprotection" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_MirrorTwoCoatingProtection</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nCurrentEncoderCount</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">encoder</span> <span class="n">count</span>
    <span class="n">neVRange</span> <span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span> <span class="o">//</span> <span class="n">Current</span> <span class="n">ev</span> <span class="nb">range</span> <span class="kn">from</span> <span class="nn">stCurrentBeamParams</span>

    <span class="n">sDevName</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Device</span> <span class="n">name</span>

    <span class="n">nUpperCoatingBoundary</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="k">for</span> <span class="n">upper</span> <span class="n">boundary</span>

    <span class="n">sUpperCoatingType</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Type</span> <span class="n">of</span> <span class="n">coating</span>

    <span class="n">nLowerCoatingBoundary</span> <span class="p">:</span> <span class="n">UDINT</span><span class="p">;</span> <span class="o">//</span> <span class="n">Encoder</span> <span class="n">count</span> <span class="k">for</span> <span class="n">lower</span> <span class="n">boundary</span>

    <span class="n">sLowerCoatingType</span> <span class="p">:</span> <span class="n">STRING</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="o">//</span> <span class="n">Type</span> <span class="n">of</span> <span class="n">coating</span>

    <span class="n">bAutoClear</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Auto</span><span class="o">-</span><span class="n">clear</span> <span class="n">these</span> <span class="n">fast</span> <span class="n">faults</span>

    <span class="n">bReadPmpsDb</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span> <span class="n">Trigger</span> <span class="n">a</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">of</span> <span class="n">the</span> <span class="n">JSON</span> <span class="n">Beam</span> <span class="n">Parameters</span>

    <span class="n">bUsePmpsDb</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">lookup</span> <span class="n">Beam</span> <span class="n">Parameters</span> <span class="n">via</span> <span class="n">DB</span><span class="o">.</span>

    <span class="n">nUpperCoatingBitmask</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">nLowerCoatingBitMask</span> <span class="p">:</span> <span class="n">DWORD</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">FFO</span> <span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">ffUpperCoating</span><span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#401,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39; mirror coating incompatible with beam photon energy&#39;</span><span class="p">);</span>
    <span class="n">ffLowerCoating</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#401,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39; mirror coating incompatible with beam photon energy&#39;</span><span class="p">);</span>
    <span class="n">ffBeamParamsNotLoaded</span> <span class="p">:</span> <span class="n">FB_FastFault</span> <span class="o">:=</span> <span class="p">(</span>
        <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#488,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39; mirror coating beam parameters not loaded&#39;</span><span class="p">);</span>

    <span class="n">aDbStateParams</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0..1</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">fbGetCoatingBPs</span> <span class="p">:</span> <span class="n">FB_JsonDocToSafeBP</span><span class="p">;</span>
    <span class="n">ftReadJsonDocDone</span> <span class="p">:</span> <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">bBPsLoaded</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">i</span> <span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">sDevState</span> <span class="p">:</span> <span class="n">STRING</span>  <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="n">bInit</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">ffUpperCoating</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">;</span>
    <span class="n">ffLowerCoating</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">sDevName</span><span class="p">;</span>
    <span class="n">IF</span> <span class="n">bUsePmpsDb</span> <span class="n">THEN</span>
        <span class="n">FOR</span> <span class="n">i</span><span class="o">:=</span><span class="mi">0</span> <span class="n">to</span> <span class="mi">1</span> <span class="n">BY</span> <span class="mi">1</span> <span class="n">DO</span>
            <span class="n">sDevState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sDevState</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">);</span>
            <span class="n">sDevState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sDevState</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">);</span>
            <span class="n">CASE</span> <span class="n">i</span> <span class="n">OF</span>
            <span class="mi">0</span><span class="p">:</span>
                <span class="n">sDevState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sDevState</span><span class="p">,</span> <span class="n">sUpperCoatingType</span><span class="p">);</span>
            <span class="mi">1</span><span class="p">:</span>
                <span class="n">sDevState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">sDevState</span><span class="p">,</span> <span class="n">sLowerCoatingType</span><span class="p">);</span>
            <span class="n">END_CASE</span>
            <span class="n">aDbStateParams</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">sDevState</span><span class="p">;</span>
            <span class="n">sDevState</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
        <span class="n">END_FOR</span>
    <span class="n">ELSE</span>
        <span class="n">bBPsLoaded</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bUsePmpsDb</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bReadPmpsDB</span> <span class="n">THEN</span>
        <span class="n">bBPsLoaded</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">fbGetCoatingBPs</span><span class="p">(</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bReadPmpsDB</span><span class="p">,</span>
        <span class="n">jsonDoc</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
        <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDevName</span><span class="p">,</span>
        <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">,</span>
        <span class="n">arrStates</span> <span class="o">:=</span> <span class="n">aDbStateParams</span><span class="p">);</span>

    <span class="n">ftReadJsonDocDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">fbGetCoatingBPs</span><span class="o">.</span><span class="n">bBusy</span><span class="p">);</span>

    <span class="n">IF</span> <span class="n">ftReadJsonDocDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">fbGetCoatingBps</span><span class="o">.</span><span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">bBPsLoaded</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">bBPsLoaded</span> <span class="n">THEN</span>
        <span class="n">nUpperCoatingBitmask</span> <span class="o">:=</span> <span class="n">aDbStateParams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
        <span class="n">nLowerCoatingBitMask</span> <span class="o">:=</span> <span class="n">aDbStateParams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">nCurrentEncoderCount</span> <span class="o">&lt;=</span> <span class="n">nLowerCoatingBoundary</span> <span class="n">THEN</span>
    <span class="n">ffLowerCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">nLowerCoatingBitMask</span><span class="p">)</span> <span class="o">=</span> <span class="n">neVRange</span><span class="p">;</span>
    <span class="n">ffUpperCoating</span><span class="o">.</span><span class="n">i_xOK</span>  <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">nCurrentEncoderCount</span> <span class="o">&gt;=</span> <span class="n">nUpperCoatingBoundary</span> <span class="n">THEN</span>
    <span class="n">ffUpperCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">(</span><span class="n">neVRange</span> <span class="n">AND</span> <span class="n">nUpperCoatingBitmask</span><span class="p">)</span> <span class="o">=</span> <span class="n">neVRange</span><span class="p">;</span>
    <span class="n">ffLowerCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">ffLowerCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ffUpperCoating</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">ffBeamParamsNotLoaded</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">bBPsLoaded</span><span class="p">;</span>

<span class="n">ffUpperCoating</span><span class="p">(</span><span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">,</span> <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoClear</span><span class="p">);</span>
<span class="n">ffLowerCoating</span><span class="p">(</span><span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">,</span> <span class="n">i_xAutoReset</span> <span class="o">:=</span> <span class="n">bAutoClear</span><span class="p">);</span>
<span class="n">ffBeamParamsNotLoaded</span><span class="p">(</span><span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">FFO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-pi-e621-serialdriver">
<h2>FB_PI_E621_SerialDriver<a class="headerlink" href="#fb-pi-e621-serialdriver" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PI_E621_SerialDriver
VAR_INPUT
    /// rising edge execute
    i_xExecute: BOOL;
    /// Maximum wait time for reply
    i_tTimeOut: TIME := TIME#1S0MS;
//  i_xReset : BOOL := FALSE; //reset function, for timeout etc
END_VAR
VAR_OUTPUT
    q_xDone: BOOL;
    q_xError: BOOL;
    q_sResult: T_MaxString;
    /// Last Strings Sent to Serial Device - for debugging
    q_asLastSentStrings: ARRAY[1..50] OF STRING;
    /// Last Strings Received from Serial Device - for debugging
    q_asLastReceivedStrings: ARRAY[1..50] OF STRING;
END_VAR
VAR_IN_OUT
    iq_stPiezoAxis  :       ST_PiezoAxis;
    iq_stSerialRXBuffer: ComBuffer;
    iq_stSerialTXBuffer: ComBuffer;
END_VAR
VAR
    rtExecute               : R_TRIG;
    rtTransDone             : R_TRIG;
    iStep: INT;
    sSendData: STRING;
    fbPITransaction: FB_PI_E621_SerialTransaction;
    fbFormatString: FB_FormatString;
    sErrMesg : STRING := &#39;In step %d fbPITransaction failed with message: %s&#39;;
    i               : INT := 1;
END_VAR
(* S. Stubbs, 2-23-2017 *)
(* This function block drives serial communication with a PI E-816 or compatible comm module.
   Note this needs to be re-jiggered if the E-517 is used, uses number rather than letter for axis *)

(* RS232 default settings: 115200 8N1, RTS/CTS

All commands follow format:
CMD X sV.V(Line feed)
Where CMD is the command, X is axis, and sV.V is sign and number (float or int).
Not all commands use axis and parameter, for example ERR?
*)

(* rising edge trigger *)
rtExecute(CLK:= i_xExecute);
IF rtExecute.Q THEN
    q_xDone := FALSE;
    q_xError := FALSE;
    q_sResult:= &#39;&#39;;
    iq_stPiezoAxis.xDriverError := FALSE;
//  i_xReset := FALSE;
    a_ClearTrans();  (* to provide rising edge for execute *)
    IF iq_stPiezoAxis.sIdn= &#39;&#39; THEN (* Should only need to check identity once *)
        iStep := 5;
    ELSE
        iStep := 10;
    END_IF
END_IF


CASE iStep OF
    0: (* idle *)
        ;

    (* Commands *)
    5: (* Get Identity *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;*IDN?&#39;;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.sIdn := fbPITransaction.q_sResponseData; //Hello I am a piezo
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    10: (* Check Servo Mode
        To use manual voltage servo mode must be off *)
        (* Response: 0$L or 1$L *)
        fbPITransaction.i_xExecute:= TRUE;
        fbPITransaction.i_sCmd:= &#39;SVO?&#39;;
        fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
            IF FIND(&#39;1&#39;,fbPITransaction.q_sResponseData) &lt;&gt; 0 THEN //Iff in servo mode, turn it off
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := iStep + 10;
            ELSE
                a_ClearTrans();
                iStep := iStep + 20;  //Skip setting servo mode
            END_IF
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    20: (* Set Servo Mode *)
        fbPITransaction.i_xExecute:= TRUE;
        fbPITransaction.i_sCmd:= &#39;SVO&#39;;
        fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        fbPITransaction.i_sParam:= &#39;0&#39;;
        fbPITransaction.i_xExpectReply:= FALSE;
        IF fbPITransaction.q_xDone THEN
            a_ClearTrans();  (* to provide rising edge for execute *)
            iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    30: (* Set Voltage, only if needed *)
        IF iq_stPiezoAxis.rSetVoltage &lt;&gt; iq_stPiezoAxis.rLastReqVoltage THEN
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;SVA&#39;;
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
            fbPITransaction.i_sParam:=REAL_TO_STRING(iq_stPiezoAxis.rSetVoltage);
            fbPITransaction.i_xExpectReply:= FALSE;
            IF fbPITransaction.q_xDone THEN
                    a_ClearTrans();  (* to provide rising edge for execute *)
                    iStep := iStep + 10;
            ELSIF fbPITransaction.q_xError THEN
                a_ErrorMesg();
                iStep := 9000;
            END_IF
        ELSE
            iStep := iStep + 30; //Should only need to check error and setpoint if setting voltage
        END_IF

    40: (* Get Error Code, also resets current error *)
    (* Response: integer error code *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;ERR?&#39;;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.iCurError := STRING_TO_INT(fbPITransaction.q_sResponseData);
                IF iq_stPiezoAxis.iCurError &lt;&gt; 0 THEN
                    iq_stPiezoAxis.iLastError:= iq_stPiezoAxis.iCurError;
                END_IF
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    50: (* Get Last Requested Piezo Voltage *)
    (* Response: (float)$L *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;SVA?&#39;;
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
            iq_stPiezoAxis.rLastReqVoltage := STRING_TO_REAL(fbPITransaction.q_sResponseData);
            //Check and reset attempts if it went through
            a_ClearTrans();  (* to provide rising edge for execute *)
            iStep := iStep + 10;
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    60: (* Get Actual Piezo Voltage *)
    (* Response: (float)$L *)
            fbPITransaction.i_xExecute:= TRUE;
            fbPITransaction.i_sCmd:= &#39;VOL?&#39;;
            // E-517 works differently, uses number rather than letter for axis
            fbPITransaction.i_sAxis:= iq_stPiezoAxis.sAxis;
        IF fbPITransaction.q_xDone THEN
                iq_stPiezoAxis.rActVoltage := STRING_TO_REAL(fbPITransaction.q_sResponseData);
                a_ClearTrans();  (* to provide rising edge for execute *)
                iStep := 8000; (* Done *)
        ELSIF fbPITransaction.q_xError THEN
            a_ErrorMesg();
            iStep := 9000;
        END_IF

    8000: (* done *)
        q_xDone := TRUE;
        IF  i_xExecute = FALSE THEN
            q_xDone:= FALSE;
            iStep := 0;
        END_IF

    9000: (* Error *)
        a_ClearTrans();  (* to provide rising edge for execute *)
        IF fbPITransaction.q_xTimeout THEN
            iStep:=10;//start over
        ELSE
        q_xError := TRUE;
        iq_stPiezoAxis.xDriverError := TRUE;
        END_IF

END_CASE

//call transaction
fbPITransaction(
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer);

iq_stPiezoAxis.xTimeout:=fbPITransaction.q_xTimeout;
(* Rising edge trigger to take care of debugging history *)
rtTransDone(CLK:= fbPITransaction.q_xDone);
IF rtTransDone.Q THEN
q_asLastSentStrings[i] := fbPITransaction.q_sLastSentString;
q_asLastReceivedStrings[i] := fbPITransaction.q_sLastReceivedString;
i := i + 1;
END_IF
IF i = 51 THEN i := 1; END_IF

END_FUNCTION_BLOCK

ACTION a_ClearTrans:
(* Refactor this action to match your transaction *)
fbPITransaction.i_xExecute := TRUE;
fbPITransaction.i_sCmd:= &#39;&#39;; //Input args are Cmd, Axis and Param
fbPITransaction.i_sAxis:= &#39;&#39;;
fbPITransaction.i_sParam:= &#39;&#39;;
fbPITransaction(
    i_tTimeOut:= i_tTimeOut,
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer );
fbPITransaction.i_xExecute := FALSE;
fbPITransaction(
    i_tTimeOut:= i_tTimeOut,
    iq_stSerialRXBuffer:= iq_stSerialRXBuffer,
    iq_stSerialTXBuffer:= iq_stSerialTXBuffer );
fbPITransaction.i_xExpectReply:=TRUE;
END_ACTION

ACTION a_ErrorMesg:
fbFormatString( sformat:=sErrMesg,
    arg1:=F_INT(iStep),
    arg2:=F_STRING(fbPITransaction.q_sResult),
    sOut =&gt; q_sResult);
END_ACTION

ACTION a_UnknownError:
q_sResult:= &#39;Unknown error&#39;;

fbFormatString( sformat:=sErrMesg,
    arg1:=F_INT(iStep),
    arg2:=F_STRING(q_sResult), //Little silly, but have to do this because F_STRING requires read/write access
    sOut =&gt; q_sResult);
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-pi-e621-serialtransaction">FB_PI_E621_SerialTransaction</a></p></li>
<li><p><a class="reference internal" href="#st-piezoaxis">ST_PiezoAxis</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pi-e621-serialtransaction">
<h2>FB_PI_E621_SerialTransaction<a class="headerlink" href="#fb-pi-e621-serialtransaction" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PI_E621_SerialTransaction
VAR_INPUT
    /// rising edge execute
    i_xExecute: BOOL;
    /// Maximum wait time for reply
    i_tTimeOut: TIME := TIME#1s0ms;
    // Command field
    i_sCmd: T_MaxString;
    // Axis field
    i_sAxis: T_MaxString;
    // Parameter field
    i_sParam: T_MaxString;
    // Does command have a reply?  Default behavior is the same as the other drivers.
    i_xExpectReply: BOOL := TRUE;
END_VAR
VAR_OUTPUT
    q_xDone: BOOL;
    q_sResponseData: STRING;
    q_xError: BOOL;
    q_xTimeout: BOOL;
    q_sResult: T_MaxString;
    /// Last String Sent to Serial Device - for debugging
    q_sLastSentString: STRING;
    /// Last String Received from Serial Device - for debugging
    q_sLastReceivedString: STRING;
END_VAR
VAR_IN_OUT
    iq_stSerialRXBuffer: ComBuffer;
    iq_stSerialTXBuffer: ComBuffer;
END_VAR
VAR
    rtExecute: R_TRIG;
    iStep: INT;
    fbClearComBuffer: ClearComBuffer;
    sSendString: STRING;
    fbFormatString: FB_FormatString;
    iChecksum: INT;
    fbSendString: SendString;
    fbReceiveString: ReceiveString;
    sReceivedString: STRING;
    tonTimeout: TON;
    sRXStringForChecksum: STRING;
    sReceiveStringWOChecksum: STRING;
    sRXCheckSum: STRING;
    sRXAddress: STRING;
    sRXParmNum: STRING;
END_VAR
(* This function block performs serial transactions with a PI E-816 or compatible comm module *)

(* rising edge trigger *)
rtExecute(CLK:= i_xExecute);
IF rtExecute.Q THEN
    q_xDone := FALSE;
    q_sResponseData := &#39;&#39;;
    q_xError := FALSE;
    q_sResult:= &#39;&#39;;
    q_sLastSentString := &#39;&#39;;
    q_sLastReceivedString:= &#39;&#39;;
    iStep := 10;
END_IF

CASE iStep OF
    0:
        ; (* idle *)

    10: (* clear com buffers *)
        fbClearComBuffer(Buffer:= iq_stSerialRXBuffer);
        fbClearComBuffer(Buffer:= iq_stSerialTXBuffer);
        (* build the send string *)
        IF i_sParam = &#39;&#39; AND i_sAxis &lt;&gt; &#39;&#39; THEN //Axis but no parameter
            fbFormatString( sFormat:= &#39;%s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sAxis),
                sOut=&gt; sSendString);
        ELSIF i_sParam &lt;&gt; &#39;&#39; AND i_sAxis = &#39;&#39; THEN //Parameter but no axis, global command
            fbFormatString( sFormat:= &#39;%s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sParam), //May not work for all commands, good enough for now
                sOut=&gt; sSendString);
        ELSIF i_sParam = &#39;&#39; AND i_sAxis = &#39;&#39; THEN //Global Query/Command
            fbFormatString( sFormat:= &#39;%s$L&#39;,
            arg1:= F_STRING(i_sCmd),
            sOut=&gt; sSendString);
        ELSE
            fbFormatString( sFormat:= &#39;%s %s %s$L&#39;,
                arg1:= F_STRING(i_sCmd),
                arg2:= F_STRING(i_sAxis),
                arg3:= F_STRING(i_sParam), //May not work for all commands, good enough for now
                sOut=&gt; sSendString);
        END_IF
        (* send it *)
        fbSendString( SendString:= sSendString, TXbuffer:= iq_stSerialTXBuffer );
        q_sLastSentString := sSendString;
        iStep := iStep + 10;

    20: (* Finish sending the String *)
        IF fbSendString.Busy THEN
            fbSendString( SendString:= sSendString, TXbuffer:= iq_stSerialTXBuffer );
        ELSIF fbSendString.Error &lt;&gt; 0 THEN
            q_sResult := CONCAT(&#39;In step 20 fbSendString resulted in error: &#39;, INT_TO_STRING(fbSendString.Error));
            iStep := 9000;
        ELSIF NOT fbSendString.Busy THEN
            IF i_xExpectReply THEN
            iStep := iStep + 10;
            ELSE //No reply expected, transaction complete
            q_xDone:= TRUE;
            q_sResult := &#39;Success.&#39;;
            q_xTimeout := FALSE; //no timeout
            iStep := 100;
            END_IF
        END_IF
        (* Reset receive *)
        fbReceiveString(
            Reset:= TRUE,
            ReceivedString:= sReceivedString,
            RXbuffer:= iq_stSerialRXBuffer );
        tonTimeout(IN:= FALSE);

    30: (* Get reply, if there is one *)
        fbReceiveString(
            Prefix:= ,
            Suffix:= &#39;$L&#39;,
            Timeout:= i_tTimeOut,
            Reset:= FALSE,
            ReceivedString:= sReceivedString,
            RXbuffer:= iq_stSerialRXBuffer );
        tonTimeout(IN:= TRUE, PT:= i_tTimeOut);
        IF fbReceiveString.Error &lt;&gt; 0 AND fbReceiveString.Error &lt;&gt; 16#1008 THEN //16#1008 is timeout error
            q_sResult := CONCAT(&#39;In step 30 fbReceiveString resulted in error: &#39;, INT_TO_STRING(fbReceiveString.Error));
            iStep := 9000;
        ELSIF fbReceiveString.RxTimeout OR tonTimeout.Q THEN
            q_sResult := &#39;Device failed to reply within timeout period&#39;;
            q_xTimeout := TRUE;
            iStep := 9000;
        ELSIF fbReceiveString.StringReceived THEN
            q_xTimeout := FALSE; //no timeout
            q_sLastReceivedString := sReceivedString;
            q_sResponseData := sReceivedString;
            q_sResult := &#39;Success.&#39;;
            q_xDone:= TRUE;
            iStep := 100;
        END_IF

    100: (* done *)
        IF  i_xExecute = FALSE THEN
            q_xDone:= FALSE;
            iStep := 0;
        END_IF

    9000:
        q_xError := TRUE;

END_CASE

END_FUNCTION_BLOCK
</pre></div>
</div>
</section>
<section id="fb-piezocontrol">
<h2>FB_PiezoControl<a class="headerlink" href="#fb-piezocontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PiezoControl</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">iq_Piezo</span>        <span class="p">:</span>       <span class="n">ST_PiezoAxis</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">xExecute</span>        <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">edge</span> <span class="n">being</span> <span class="n">piezo</span> <span class="n">motion</span>
    <span class="n">xReset</span>      <span class="p">:</span>   <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Enable_Positive</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reverse</span> <span class="n">of</span> <span class="n">Positive</span> <span class="n">Limit</span> <span class="n">Switch</span>
    <span class="n">Enable_Negative</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reverse</span> <span class="n">of</span> <span class="n">Negative</span> <span class="n">Limit</span> <span class="n">Switch</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">xBusy</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Busy</span> <span class="n">remains</span> <span class="n">true</span> <span class="k">while</span> <span class="n">piezo</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">adjusted</span>
    <span class="n">xDone</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Reached</span> <span class="n">target</span> <span class="n">position</span>
    <span class="n">xError</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">General</span> <span class="n">error</span>
    <span class="n">xLimited</span><span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Piezo</span> <span class="n">move</span> <span class="n">was</span> <span class="n">limited</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">E_State</span>     <span class="p">:</span> <span class="n">E_PiezoControl</span><span class="p">;</span> <span class="o">//</span><span class="n">ENUM</span> <span class="k">for</span> <span class="n">Piezo</span> <span class="n">Control</span> <span class="n">State</span>
    <span class="n">rtStartMove</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Trigger</span> <span class="k">for</span> <span class="n">Execution</span>
    <span class="n">rtReset</span>     <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span> <span class="o">//</span><span class="n">Rising</span> <span class="n">Trigger</span> <span class="k">for</span> <span class="n">Error</span> <span class="n">reset</span>
    <span class="n">rSetpoint</span>   <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>   <span class="o">//</span><span class="n">Internal</span> <span class="n">Storage</span> <span class="n">of</span> <span class="n">Setpoint</span>
    <span class="n">rReqVoltage</span>     <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">requested</span> <span class="n">voltage</span>
    <span class="n">rLLSV</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">rHLSV</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">120</span><span class="p">;</span>
    <span class="n">fbPI</span><span class="p">:</span> <span class="n">FB_CTRL_PI</span><span class="p">;</span>
    <span class="n">fbRamp</span><span class="p">:</span> <span class="n">FB_CTRL_RAMP_GENERATOR_EXT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">FB</span> <span class="n">initialized</span> <span class="n">flag</span>
    <span class="n">bInitialized</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span><span class="n">Get</span> <span class="n">cycle</span> <span class="n">time</span> <span class="k">for</span> <span class="n">control</span> <span class="n">FBs</span>
    <span class="n">fbGetCycleTime</span>  <span class="p">:</span>       <span class="n">FB_CTRL_GET_TASK_CYCLETIME</span><span class="p">;</span>
    <span class="n">tTaskCycleTime</span><span class="p">:</span> <span class="n">TIME</span><span class="p">;</span>
    <span class="n">bCycleTimeValid</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">rtVoltMode</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fOut</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPiezoBias</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="n">fScale</span><span class="p">:</span> <span class="n">REAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span>
    <span class="n">tonPiezoDone</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2S);</span>
    <span class="n">tonPiezoLimited</span><span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#500MS);</span>
    <span class="n">xVoltageLimited</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">ftEnPos</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">ftEnNeg</span> <span class="p">:</span>       <span class="n">F_TRIG</span><span class="p">;</span>
    <span class="n">rtEnPos</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rtEnNeg</span> <span class="p">:</span>       <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">fOutLimitHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">fOutHiLimHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">fOutLoLimHolder</span> <span class="p">:</span>       <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">holds</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">value</span> <span class="n">until</span> <span class="n">restored</span>
    <span class="n">xFirstPass</span>      <span class="p">:</span>       <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">FB</span> <span class="n">Piezo</span> <span class="n">Control</span>

<span class="o">//</span><span class="n">Triggers</span>
<span class="o">///////////////////////////////</span>
    <span class="n">rtStartMove</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">xExecute</span><span class="p">);</span>
    <span class="n">rtReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xEnable</span><span class="p">);</span>
    <span class="n">rtVoltMode</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xVoltageMode</span><span class="p">);</span>

<span class="o">//</span><span class="n">Status</span> <span class="n">bits</span>
<span class="o">///////////////////////////</span>
<span class="n">xBusy</span> <span class="n">S</span><span class="o">=</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">xDone</span> <span class="n">R</span><span class="o">=</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="o">//</span><span class="n">Keep</span> <span class="n">requested</span> <span class="n">voltage</span> <span class="n">to</span> <span class="n">within</span> <span class="n">limits</span>
<span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">LowerVoltage</span><span class="p">,</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">UpperVoltage</span><span class="p">);</span>

<span class="o">//</span><span class="n">Limits</span>
<span class="p">(</span><span class="o">*</span> <span class="n">These</span> <span class="n">appear</span> <span class="n">flipped</span><span class="p">,</span> <span class="n">but</span> <span class="ow">in</span><span class="o">-</span><span class="n">fact</span> <span class="n">are</span> <span class="ow">not</span> <span class="o">*</span><span class="p">)</span>
<span class="n">ftEnPos</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Positive</span><span class="p">);</span>
<span class="n">ftEnNeg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">);</span>
<span class="n">rtEnPos</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Positive</span><span class="p">);</span>
<span class="n">rtEnNeg</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Enable_Negative</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">xFirstPass</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">Want</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">the</span> <span class="n">limits</span> <span class="n">on</span> <span class="n">first</span> <span class="k">pass</span> <span class="k">if</span> <span class="n">a</span> <span class="n">switch</span> <span class="ow">is</span> <span class="n">hit</span><span class="o">.</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">When</span> <span class="n">we</span> <span class="n">move</span> <span class="n">off</span> <span class="n">the</span> <span class="n">limit</span><span class="p">,</span> <span class="n">we</span><span class="s1">&#39;ll restore the init value (usually 1). This will be reset</span>
    <span class="n">to</span> <span class="n">something</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">1</span> <span class="n">when</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">gets</span> <span class="n">tripped</span> <span class="n">again</span><span class="p">,</span> <span class="n">because</span> <span class="n">presumably</span> <span class="n">the</span> <span class="n">actual</span> <span class="n">limit</span>
    <span class="n">would</span> <span class="n">have</span> <span class="n">been</span> <span class="nb">set</span> <span class="n">at</span> <span class="n">a</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">the</span> <span class="n">system</span> <span class="n">had</span> <span class="n">been</span> <span class="n">runing</span><span class="o">.</span>
    <span class="n">We</span> <span class="n">just</span> <span class="n">need</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">the</span> <span class="n">init</span> <span class="n">value</span> <span class="n">to</span> <span class="n">make</span> <span class="n">it</span> <span class="n">past</span> <span class="n">this</span> <span class="n">edge</span> <span class="n">case</span> <span class="n">that</span> <span class="ow">is</span> <span class="n">present</span> <span class="n">at</span> <span class="n">startup</span><span class="o">.</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">Enable_Positive</span> <span class="n">THEN</span> <span class="n">fOutHiLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span><span class="p">;</span> <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="n">NOT</span> <span class="n">Enable_Negative</span> <span class="n">THEN</span> <span class="n">fOutLoLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span><span class="p">;</span> <span class="n">END_IF</span>
<span class="n">ELSE</span>
    <span class="n">IF</span> <span class="n">ftEnPos</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rLLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span><span class="p">;</span>
        <span class="n">fOutHiLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">rtEnPos</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rLLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">LowerVoltage</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMaxLimit</span> <span class="o">:=</span> <span class="n">fOutHiLimHolder</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="n">IF</span> <span class="n">ftEnNeg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rHLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span><span class="p">;</span>

        <span class="n">fOutLoLimHolder</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span><span class="p">;</span>
    <span class="n">ELSIF</span> <span class="n">rtEnNeg</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">rHLSV</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">UpperVoltage</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">fOutMinLimit</span> <span class="o">:=</span> <span class="n">fOutLoLimHolder</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Don</span><span class="s1">&#39;t do anything until we&#39;</span><span class="n">re</span> <span class="n">ready</span>
<span class="n">IF</span> <span class="n">bInitialized</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">While</span> <span class="n">the</span> <span class="n">block</span> <span class="ow">is</span> <span class="n">working</span><span class="p">,</span> <span class="n">a</span> <span class="n">new</span> <span class="n">position</span> <span class="n">may</span> <span class="n">be</span> <span class="n">requested</span><span class="p">,</span> <span class="n">this</span> <span class="ow">is</span> <span class="n">OK</span>
    <span class="n">IF</span> <span class="n">xBusy</span> <span class="n">THEN</span>
        <span class="n">fbPI</span><span class="o">.</span><span class="n">fSetpointValue</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqAbsPos</span><span class="p">;</span>
    <span class="n">END_IF</span>

    <span class="p">(</span><span class="o">*</span> <span class="n">The</span> <span class="nb">next</span> <span class="n">chunk</span> <span class="n">of</span> <span class="n">code</span> <span class="n">prevents</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="kn">from</span> <span class="nn">winding</span> <span class="n">up</span><span class="o">.</span>
        <span class="n">First</span><span class="p">,</span> <span class="n">when</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">begins</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">voltage</span> <span class="n">that</span> <span class="ow">is</span>
        <span class="n">beyond</span> <span class="n">the</span> <span class="n">permitted</span> <span class="nb">range</span> <span class="p">(</span><span class="n">this</span> <span class="nb">range</span> <span class="ow">is</span> <span class="n">affected</span> <span class="n">by</span> <span class="n">the</span> <span class="n">state</span>
        <span class="n">of</span> <span class="n">limit</span> <span class="n">switches</span><span class="o">/</span> <span class="ow">or</span> <span class="n">enable</span> <span class="n">fwd</span><span class="o">/</span><span class="n">bwd</span><span class="p">),</span> <span class="n">we</span> <span class="n">latch</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">position</span><span class="o">.</span>
        <span class="n">Presumeably</span> <span class="n">this</span> <span class="n">position</span> <span class="n">request</span>  <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span><span class="n">Select</span> <span class="n">the</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">control</span> <span class="n">mode</span>
    <span class="o">////////////////////////////////////////</span>
    <span class="n">IF</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xVoltageMode</span> <span class="n">THEN</span>
        <span class="o">//</span><span class="n">Set</span> <span class="n">PI</span> <span class="n">block</span> <span class="n">to</span> <span class="n">idle</span>
        <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_PASSIVE</span><span class="p">;</span>
        <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqVoltage</span><span class="p">;</span> <span class="o">//</span><span class="n">TODO</span> <span class="n">add</span> <span class="n">a</span> <span class="n">ramp</span>
    <span class="n">ELSE</span>
        <span class="n">IF</span> <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">xIdleMode</span> <span class="n">THEN</span>
            <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">fScale</span> <span class="o">*</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">fPiezoBias</span><span class="p">;</span>

            <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_MANUAL</span><span class="p">;</span>
            <span class="n">ACT_Controller</span><span class="p">();</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">bHold</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">ELSE</span>
            <span class="o">//</span><span class="n">Fout</span> <span class="ow">is</span> <span class="n">connected</span> <span class="n">to</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">voltage</span> <span class="n">control</span>
            <span class="n">rReqVoltage</span> <span class="o">:=</span> <span class="n">fScale</span> <span class="o">*</span> <span class="n">fbPI</span><span class="o">.</span><span class="n">fOut</span> <span class="o">+</span> <span class="n">fPiezoBias</span><span class="p">;</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">bHold</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="o">//</span><span class="n">Control</span> <span class="n">mode</span> <span class="ow">is</span> <span class="n">always</span> <span class="n">active</span><span class="p">,</span> <span class="n">so</span> <span class="n">compensation</span> <span class="n">takes</span> <span class="n">over</span> <span class="n">more</span> <span class="n">smoothly</span>
            <span class="n">fbPI</span><span class="o">.</span><span class="n">eMode</span> <span class="o">:=</span> <span class="n">eCTRL_MODE_ACTIVE</span><span class="p">;</span>
        <span class="n">END_IF</span>

    <span class="n">END_IF</span>

    <span class="n">ACT_Controller</span><span class="p">();</span>

    <span class="n">xVoltageLimited</span> <span class="o">:=</span> <span class="n">rLLSV</span> <span class="o">&gt;</span> <span class="n">rReqVoltage</span> <span class="n">OR</span> <span class="n">rHLSV</span> <span class="o">&lt;</span> <span class="n">rReqVoltage</span><span class="p">;</span>

    <span class="o">//</span><span class="n">This</span> <span class="ow">is</span> <span class="n">where</span> <span class="n">the</span> <span class="n">voltage</span> <span class="n">request</span> <span class="n">gets</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">the</span> <span class="n">piezo</span> <span class="n">driver</span>
    <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rSetVoltage</span> <span class="o">:=</span> <span class="n">LIMIT</span><span class="p">(</span><span class="n">rLLSV</span><span class="p">,</span> <span class="n">rReqVoltage</span><span class="p">,</span> <span class="n">rHLSV</span><span class="p">);</span>

<span class="o">//</span><span class="n">Initialization</span>
<span class="n">ELSE</span>
    <span class="n">fbGetCycleTime</span><span class="p">(</span> <span class="n">eMode</span>   <span class="o">:=</span> <span class="n">eCTRL_MODE_ACTIVE</span><span class="p">,</span>
                <span class="n">tTaskCycleTime</span> <span class="o">=&gt;</span> <span class="n">tTaskCycleTime</span><span class="p">,</span>
                <span class="n">bCycleTimeValid</span> <span class="o">=&gt;</span> <span class="n">bCycleTimeValid</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">bCycleTimeValid</span> <span class="n">THEN</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">tTaskCycleTime</span> <span class="o">:=</span> <span class="n">tTaskCycleTime</span><span class="p">;</span>
        <span class="n">iq_Piezo</span><span class="o">.</span><span class="n">stPIParams</span><span class="o">.</span><span class="n">tCtrlCycleTime</span> <span class="o">:=</span> <span class="n">tTaskCycleTime</span><span class="p">;</span>
        <span class="n">bInitialized</span>        <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">END_IF</span>

<span class="n">END_IF</span>

<span class="n">tonPiezoDone</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="n">WithinRange</span><span class="p">(</span><span class="n">ValA</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rActPos</span><span class="p">,</span> <span class="n">Center</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rReqAbsPos</span><span class="p">,</span> <span class="n">Range</span><span class="o">:=</span><span class="n">iq_Piezo</span><span class="o">.</span><span class="n">rPiezoDmovRange</span><span class="p">,</span> <span class="n">Offset</span><span class="o">:=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">AND</span> <span class="n">NOT</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span> <span class="o">//</span><span class="n">rtStartMove</span> <span class="n">interrupts</span> <span class="n">the</span> <span class="n">timer</span><span class="p">,</span> <span class="n">resetting</span> <span class="n">it</span>
<span class="n">tonPiezoDone</span><span class="p">();</span>

<span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">IN</span> <span class="o">:=</span> <span class="p">(</span><span class="n">fbPI</span><span class="o">.</span><span class="n">bARWactive</span> <span class="n">OR</span> <span class="n">xVoltageLimited</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">rtStartMove</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>
<span class="n">tonPiezoLimited</span><span class="p">();</span>

<span class="n">xDone</span> <span class="n">S</span><span class="o">=</span> <span class="n">xBusy</span> <span class="n">AND</span> <span class="p">(</span><span class="n">tonPiezoDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">OR</span> <span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">Q</span><span class="p">);</span>
<span class="n">xLimited</span> <span class="o">:=</span> <span class="n">tonPiezoLimited</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">xBusy</span> <span class="n">R</span><span class="o">=</span> <span class="n">xDone</span><span class="p">;</span>

<span class="n">xFirstPass</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_CheckLimits</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Controller</span><span class="p">:</span>

<span class="n">END_ACTION</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-piezocontrol">E_PiezoControl</a></p></li>
<li><p><a class="reference internal" href="#st-piezoaxis">ST_PiezoAxis</a></p></li>
<li><p><a class="reference internal" href="#withinrange">WithinRange</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pitchcontrol">
<h2>FB_PitchControl<a class="headerlink" href="#fb-pitchcontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PitchControl
VAR_IN_OUT
    Pitch : HOMS_PitchMechanism;
    Stepper : ST_MotionStage;
END_VAR
VAR_INPUT
    lrCurrentSetpoint : LREAL; // Setpoint: Epics writes to ST_MotionStage which gets fed into this
END_VAR
VAR_OUTPUT
    q_bError : BOOL;
    q_bDone : BOOL;
    q_bBusy : BOOL;
END_VAR
VAR
    // Logging
    stDiag : ST_fbDiagnostics;
    fbFormatString : FB_FormatString;
    {attribute &#39;instance-path&#39;}
    {attribute &#39;no_init&#39;}
    POUName : T_MaxString; // Name of the POU for logging/error reporting

    // Stepper Motion
    lrActPos : LREAL; // Actual Position of piezo mechanism
    lrPrevStepperPos : LREAL; // Previous successfully achieved stepper position
    ftLimitSwitch : F_TRIG;
    lrOriginalPosRequest : LREAL; // Used for logging
    lrLastSetpoint : LREAL; // Previous successfully achieved setpoint
    fbMotionRequest : FB_MotionRequest;
    fbMotionStage : FB_MotionStage;
    bLimitHit : BOOL;
    tonStepperHold : TON := (PT:=T#100MS); // Timer to hold stepper position while the system relaxes
    rSettledRange : REAL := 5.0; // Units = urad
    bResetStepper : BOOL;
    bExecuteStepper : BOOL;
    enumMotionRequest : ENUM_MotionRequest := ENUM_MotionRequest.WAIT; // Wait for move to complete before taking another request

    // Piezo
    tonPiezoSettled : TON := (PT:=T#2S);
    fbPiezoControl : FB_PiezoControl;
    rtPiezoMoveDone : R_TRIG;

    // State Machine
    PC_State : E_PitchControl := PCM_Init;
    bCoarse50PiezoMove : BOOL;
END_VAR
(* HOMS Pitch Control
A. Wallace
J. Sheppard - Updating to new lcls-twincat-motion API

The HOMS Pitch mechanism consists of a stepper and piezo that work together to adjust
the pitch of the mirror assembly.

Pitch control state machine

If the target position is beyond the range of the piezo mechanism,
execute a coarse pitch move with the stepper.
The target of the coarse move shall be set to the requested position.
Once coarse motion has completed the coarse motion drive position
correction output shall be set to zero.

Fine pitch motion with the piezo will be initiated to finish closing the loop.

The piezo mechanism can actuate ~ 180urad or 90um.

*)
lrActPos := Stepper.stAxisStatus.fActPosition;

// If we hit a limit during a move, we need to change the setpoint
ftLimitSwitch(CLK:=Stepper.bAllForwardEnable AND Stepper.bAllBackwardEnable);
IF ftLimitSwitch.Q THEN
    bExecuteStepper := FALSE;
    bLimitHit := TRUE;
    lrCurrentSetpoint := lrActPos;
END_IF

// Left out Manual Mode Switch and Tweak FBs

// State Machine
CASE PC_State OF
    PCM_Init:
        lrCurrentSetpoint := lrActPos;
        lrLastSetpoint := lrCurrentSetpoint;
        lrPrevStepperPos := lrCurrentSetpoint;
        PC_State := PCM_Standby;
    PCM_Standby:
        // Waits for move requests and determines if they are valid
        IF (lrLastSetpoint &lt;&gt; lrCurrentSetpoint) THEN // lrLastSetpoint initially set in PCM_Done
            // Check for bad setpoints -&gt; revert to previous setpoint
            IF      (lrCurrentSetpoint &gt; Pitch.ReqPosLimHi) OR (lrCurrentSetpoint &lt; Pitch.ReqPosLimLo) OR NOT Stepper.bHardwareEnable THEN
                // Outside range of limit switches or bHardwareEnable is FALSE
                ACT_ResetSetpoint();
            ELSIF lrCurrentSetpoint &gt; lrLastSetpoint AND NOT Stepper.bAllForwardEnable THEN
                // Forward move when on HL
                ACT_ResetSetpoint();
            ELSIF lrCurrentSetpoint &lt; lrLastSetpoint AND NOT Stepper.bAllBackwardEnable THEN
                // Backward move when on LL
                ACT_ResetSetpoint();
            END_IF
            // If the current setpoint still differs from the prvious, we know the move is safe and OK to proceed
            IF lrLastSetpoint &lt;&gt; lrCurrentSetpoint THEN
                q_bDone := FALSE;
                PC_State := PCM_MoveRequested;
            END_IF
        END_IF
    PCM_MoveRequested:
        // A move has been requested, is it within range of the piezo?
        IF WithinRange(ValA:=lrCurrentSetpoint, Center:=lrPrevStepperPos, Range:=GVL_Constants.cPiezoRange, Offset:=0) THEN
            // Move is within the nominal range of the piezo
            fbFormatString.sFormat := &#39;Within range, fine move %f&#39;;
            fbFormatString.arg1 := F_LREAL(lrCurrentSetpoint);
            fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            PC_State := PCM_FineMove;
        ELSE
            // Out of range, head to coarse move
            fbFormatString.arg1 := F_LREAL(lrCurrentSetpoint);
            fbFormatString.sFormat := &#39;OoR, using stepper %f&#39;;
            fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
            PC_State := PCM_Coarse50Piezo;
        END_IF
    PCM_Coarse50Piezo:
        // A coarse move uses the stepper to do a best-effort position
        // First set the piezo to nominal 50% extension using idle mode
        //////////////////////////////////////////////////////////////////////////////
        Pitch.Piezo.xIdleMode := TRUE;
        // Indicate we are doing the coarse 50% piezo move
        bCoarse50PiezoMove := TRUE;
        // Wait for piezo to settle
        tonPiezoSettled.IN := TRUE;
        bCoarse50PiezoMove R= tonPiezoSettled.Q;
        IF tonPiezoSettled.Q THEN
            //Piezo has moved to 50% position, finish with the stepper
            PC_State := PCM_CoarseMove;
            tonPiezoSettled.IN := FALSE;
        END_IF
    PCM_CoarseMove:
        // With the piezo at a nominal 50% extension, move the stepper to requested position
        bExecuteStepper := TRUE;
        // Timer that waits to start until stepper is within range of the setpoint
        tonStepperHold.IN := WithinRange(ValA:=LREAL_TO_REAL(lrActPos), Center:=lrCurrentSetpoint, Range:=rSettledRange, Offset:=0);
        tonStepperHold(); // call this here to reset Q just below on first cycle
        // If the coarse move is complete, finish position correction with the piezo
        IF tonStepperHold.Q  OR ftLimitSwitch.Q THEN
            PC_State := PCM_CoarseMoveCleanup;
            lrPrevStepperPos := lrActPos;
        ELSIF Stepper.bError THEN
            bExecuteStepper := FALSE;
            PC_State := PCM_StepperError;
            // Left out logging
        END_IF
    PCM_CoarseMoveCleanup:
        bExecuteStepper := FALSE;
        PC_State := PCM_FineMove;
    PCM_FineMove:
        Pitch.Piezo.xIdleMode := FALSE;
        fbPiezoControl.xExecute := TRUE;
        IF bLimitHit THEN
            Pitch.Piezo.rReqAbsPos := lrActPos;
        ELSE
            Pitch.Piezo.rReqAbsPos := lrCurrentSetpoint;
        END_IF
        rtPiezoMoveDone(CLK:=fbPiezoControl.xDone);
        IF rtPiezoMoveDone.Q THEN
            fbPiezoControl.xExecute := FALSE;
            PC_State := PCM_Done;
        END_IF
    PCM_Done:
        // Set the previously requested position here
        lrLastSetpoint := lrCurrentSetpoint;
        bLimitHit := FALSE;
        // Indicate we&#39;re done
        q_bDone     := TRUE;
        // Move back to standby
        PC_State := PCM_Standby;
    PCM_StepperError:
        PC_State := PCM_Init;
    PCM_PiezoError:
        PC_State := PCM_Init;
    PCM_OtherError:
        PC_State := PCM_Init;
END_CASE

fbMotionStage(stMotionStage:=Stepper);

// Transfer to the Piezo
Pitch.Piezo.rActPos := lrActPos;

tonPiezoSettled();
tonStepperHold();
fbPiezoControl(iq_Piezo:=Pitch.Piezo,
               Enable_Positive:=Stepper.bLimitForwardEnable,
               Enable_Negative:=Stepper.bLimitBackwardEnable);

END_FUNCTION_BLOCK

ACTION ACT_ResetSetpoint:
// Action to reset the Setpoint to the previous value when:
// - New setpoint outside range of soft limits
// - bHardwareEnable is FALSE
// - Limit switches are hit and new setpoint the direction of the hit switch

lrOriginalPosRequest := lrCurrentSetpoint;
lrCurrentSetpoint := lrLastSetpoint;
// Only want to log one warning about a bad position request
IF lrOriginalPosRequest &lt;&gt; lrCurrentSetpoint THEN
    // Log a warning
    fbFormatString.sFormat := &#39;Pitch req OoR fb (%s), reset within limits, %f&#39;;
    fbFormatString.arg1 := F_STRING(POUName);
    fbFormatString.arg2 := F_LREAL(lrOriginalPosRequest);
    fbFormatString(sOut=&gt;stDiag.asResults[stDiag.resultIdx.IncVal()]);
    PC_State := PCM_Standby;
END_IF
END_ACTION
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-pitchcontrol">E_PitchControl</a></p></li>
<li><p><a class="reference internal" href="#fb-piezocontrol">FB_PiezoControl</a></p></li>
<li><p><a class="reference internal" href="#gvl-constants">GVL_Constants</a></p></li>
<li><p><a class="reference internal" href="#homs-pitchmechanism">HOMS_PitchMechanism</a></p></li>
<li><p><a class="reference internal" href="#withinrange">WithinRange</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-rmswatch">
<h2>FB_RMSWatch<a class="headerlink" href="#fb-rmswatch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_RMSWatch</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">RMS</span> <span class="n">Error</span>
    <span class="n">fMaxRMSError</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fMinRMSError</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span> <span class="o">//</span> <span class="n">start</span> <span class="n">at</span> <span class="n">something</span> <span class="n">huge</span><span class="p">,</span> <span class="n">FB</span> <span class="n">will</span> <span class="n">update</span> <span class="k">with</span> <span class="nb">any</span> <span class="n">smaller</span> <span class="n">measured</span> <span class="n">value</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stMotionStage</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fEncScalingNum</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">fEncScalingDenom</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="n">fEncOffset</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">fEncScale</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">1.0</span><span class="p">;</span>

    <span class="n">fbDataEncPos</span> <span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span> <span class="o">//</span> <span class="n">ActPos</span> <span class="n">Data</span> <span class="n">Acquisition</span> <span class="n">FB</span>
    <span class="n">fbDataSetPos</span> <span class="p">:</span> <span class="n">FB_LREALBuffer</span><span class="p">;</span> <span class="o">//</span> <span class="n">SetPos</span> <span class="n">Data</span> <span class="n">Acquisition</span> <span class="n">FB</span>
    <span class="n">bExecuteDataStorage</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span> <span class="o">//</span> <span class="n">Take</span> <span class="n">data</span> <span class="n">of</span> <span class="n">both</span> <span class="n">ActPos</span> <span class="ow">and</span> <span class="n">SetPos</span>
    <span class="n">bNewEncArray</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbStats</span> <span class="p">:</span> <span class="n">FB_BasicStats</span><span class="p">;</span> <span class="o">//</span> <span class="n">Calculate</span> <span class="n">mean</span><span class="o">/</span><span class="n">standard</span> <span class="n">deviation</span> <span class="n">of</span> <span class="n">ActPos</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MEAN</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncMean</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">STDEV</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fEncStDev</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RMS</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">fCurrRMSError</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">nIndex</span> <span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">fSum</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span> <span class="n">Just</span> <span class="k">for</span> <span class="n">calculating</span> <span class="n">rms</span>
    <span class="n">fDiff</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ACTPOSARRAY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">aEncActPos</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SETPOSARRAY</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">aEncSetPos</span> <span class="p">:</span> <span class="n">ARRAY</span> <span class="p">[</span><span class="mf">1..1000</span><span class="p">]</span> <span class="n">OF</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Encoder</span> <span class="n">Scaling</span>
<span class="n">fEncScalingNum</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorNumerator</span><span class="p">;</span>
<span class="n">fEncScalingDenom</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncScaleFactorDenominator</span><span class="p">;</span>
<span class="n">fEncOffset</span> <span class="o">:=</span> <span class="n">stMotionStage</span><span class="o">.</span><span class="n">stAxisParameters</span><span class="o">.</span><span class="n">fEncOffset</span><span class="p">;</span>
<span class="n">fEncScale</span> <span class="o">:=</span> <span class="n">fEncScalingNum</span> <span class="o">/</span> <span class="n">fEncScalingDenom</span><span class="p">;</span>

<span class="o">//</span> <span class="n">FB</span> <span class="n">to</span> <span class="n">store</span> <span class="n">encoder</span> <span class="n">positions</span> <span class="ow">in</span> <span class="mi">1000</span> <span class="n">element</span> <span class="n">arrays</span><span class="p">,</span> <span class="n">compute</span> <span class="n">RMS</span> <span class="n">errors</span><span class="p">,</span> <span class="ow">and</span> <span class="n">watch</span> <span class="k">for</span> <span class="nb">min</span><span class="o">/</span><span class="nb">max</span>
<span class="o">//</span> <span class="n">Encoder</span> <span class="n">Readback</span><span class="o">/</span><span class="n">Storage</span>
<span class="n">fbDataEncPos</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteDataStorage</span><span class="p">,</span>
                <span class="n">fInput</span><span class="o">:=</span> <span class="n">ULINT_TO_LREAL</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">nRawEncoderULINT</span><span class="p">),</span>
                <span class="n">arrOutput</span><span class="o">=&gt;</span><span class="n">aEncActPos</span><span class="p">,</span>
             <span class="n">bNewArray</span><span class="o">=&gt;</span><span class="n">bNewEncArray</span><span class="p">);</span>

<span class="n">fbDataSetPos</span><span class="p">(</span><span class="n">bExecute</span><span class="o">:=</span><span class="n">bExecuteDataStorage</span><span class="p">,</span>
              <span class="n">fInput</span><span class="o">:=</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">SetPos</span> <span class="o">-</span> <span class="n">fEncOffset</span><span class="p">)</span> <span class="o">/</span> <span class="n">fEncScale</span><span class="p">,</span>
                <span class="n">arrOutput</span><span class="o">=&gt;</span><span class="n">aEncSetPos</span><span class="p">);</span>

<span class="n">fbStats</span><span class="p">(</span><span class="n">aSignal</span><span class="o">:=</span><span class="n">aEncActPos</span><span class="p">,</span>
        <span class="n">bAlwaysCalc</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
        <span class="n">fMean</span><span class="o">=&gt;</span><span class="n">fEncMean</span><span class="p">,</span>
        <span class="n">fStDev</span><span class="o">=&gt;</span><span class="n">fEncStDev</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Calculate</span> <span class="n">RMS</span> <span class="n">Error</span><span class="p">:</span>
<span class="n">If</span> <span class="n">bNewEncArray</span> <span class="n">THEN</span>
    <span class="n">fCurrRMSError</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">FOR</span> <span class="n">nIndex</span> <span class="o">:=</span> <span class="mi">2</span> <span class="n">TO</span> <span class="mi">1000</span> <span class="n">DO</span>
        <span class="o">//</span> <span class="n">First</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">array</span> <span class="n">stuck</span> <span class="k">as</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">some</span> <span class="n">reason</span><span class="o">...</span>
        <span class="n">fDiff</span> <span class="o">:=</span> <span class="n">aEncActPos</span><span class="p">[</span><span class="n">nIndex</span><span class="p">]</span> <span class="o">-</span> <span class="n">aEncSetPos</span><span class="p">[</span><span class="n">nIndex</span><span class="p">];</span>
        <span class="n">fSum</span> <span class="o">:=</span> <span class="n">EXPT</span><span class="p">(</span><span class="n">fDiff</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">fCurrRMSError</span> <span class="o">:=</span> <span class="n">fCurrRMSError</span> <span class="o">+</span> <span class="n">fSum</span><span class="p">;</span>
    <span class="n">END_FOR</span><span class="p">;</span>
    <span class="n">fCurrRMSError</span> <span class="o">:=</span> <span class="n">fCurrRMSError</span> <span class="o">/</span> <span class="mf">999.0</span><span class="p">;</span> <span class="o">//</span> <span class="mi">1000</span> <span class="n">element</span> <span class="n">array</span> <span class="n">but</span> <span class="n">ditched</span> <span class="n">the</span> <span class="n">first</span> <span class="n">point</span>
    <span class="n">fCurrRMSError</span> <span class="o">:=</span> <span class="n">SQRT</span><span class="p">(</span><span class="n">fCurrRMSError</span><span class="p">);</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="k">for</span> <span class="nb">max</span><span class="p">:</span>
    <span class="n">IF</span> <span class="n">fCurrRMSError</span> <span class="o">&gt;</span> <span class="n">fMaxRMSError</span> <span class="n">THEN</span>
        <span class="n">fMaxRMSError</span> <span class="o">:=</span> <span class="n">fCurrRMSError</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="o">//</span> <span class="n">Watch</span> <span class="k">for</span> <span class="nb">min</span><span class="p">:</span>
    <span class="n">IF</span> <span class="n">fCurrRMSError</span> <span class="o">&lt;</span> <span class="n">fMinRMSError</span> <span class="n">THEN</span>
        <span class="n">fMinRMSError</span> <span class="o">:=</span> <span class="n">fCurrRMSError</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">fCurrRMSError</span> <span class="o">:=</span> <span class="n">fCurrRMSError</span> <span class="o">*</span> <span class="n">fEncScale</span><span class="p">;</span>
    <span class="n">fMaxRMSError</span> <span class="o">:=</span> <span class="n">FMaxRMSError</span> <span class="o">*</span> <span class="n">fEncScale</span><span class="p">;</span>
    <span class="n">fMinRMSError</span> <span class="o">:=</span> <span class="n">FMinRMSError</span> <span class="o">*</span> <span class="n">fEncScale</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Scale</span> <span class="n">to</span> <span class="n">Actual</span> <span class="n">values</span>
<span class="n">fEncStDev</span> <span class="o">:=</span> <span class="n">fEncStDev</span> <span class="o">*</span> <span class="n">fEncScale</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-runhoms">
<h2>FB_RunHOMS<a class="headerlink" href="#fb-runhoms" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_RunHOMS
VAR_INPUT
    // Encoder Reference Values
    nYupEncRef : ULINT;
    nYdwnEncRef : ULINT;
    nXupEncRef : ULINT;
    nXdwnEncRef : ULINT;

    // Gantry Tolerances
    nGantryTolY : LINT := GVL_Constants.nGANTRY_TOLERANCE_NM_DEFAULT; // Encoder counts = nm
    nGantryTolX : LINT := GVL_Constants.nGANTRY_TOLERANCE_NM_DEFAULT; // Encoder counts = nm
END_VAR
VAR_OUTPUT
    // Gantry coupling status
    bGantryAlreadyCoupledY : BOOL;
    bGantryAlreadyCoupledX : BOOL;

    // Current gantry difference
    nCurrGantryY : LINT;
    nCurrGantryX : LINT;
END_VAR
VAR_IN_OUT
    // Motor Structs
    stYup : ST_MotionStage;
    stYdwn : ST_MotionStage;
    stXup : ST_MotionStage;
    stXdwn : ST_MotionStage;
    stPitch : ST_MotionStage;

    // Manual coupling Gantried Axes
    bExecuteCoupleY : BOOL;
    bExecuteCoupleX : BOOL;
    bExecuteDecoupleY : BOOL;
    bExecuteDecoupleX : BOOL;
END_VAR
VAR
    // STO Button
    bSTOEnable1 AT %I* : BOOL;
    bSTOEnable2 AT %I* : BOOL;

    // Encoders
    stYupEnc AT %I* : ST_RenishawAbsEnc;
    stYdwnEnc AT %I* : ST_RenishawAbsEnc;

    stXupEnc AT %I* : ST_RenishawAbsEnc;
    stXdwnEnc AT %I* : ST_RenishawAbsEnc;

    // Autocoupling Gantried Axes
    fbAutoCoupleY : FB_GantryAutoCoupling;
    fbAutoCoupleX : FB_GantryAutoCoupling;
END_VAR
// Encoder Reference Values
stYupEnc.Ref := nYupEncRef;
stYdwnEnc.Ref := nYdwnEncRef;
stXupEnc.Ref := nXupEncRef;
stXdwnEnc.Ref := nXdwnEncRef;

// Gantry Differences to monitor
nCurrGantryY := ((ULINT_TO_LINT(stYupEnc.Count) - ULINT_TO_LINT(stYupEnc.Ref)) - (ULINT_TO_LINT(stYdwnEnc.Count) - ULINT_TO_LINT(stYdwnEnc.Ref)));
nCurrGantryX := ((ULINT_TO_LINT(stXupEnc.Count) - ULINT_TO_LINT(stXupEnc.Ref)) - (ULINT_TO_LINT(stXdwnEnc.Count) - ULINT_TO_LINT(stXdwnEnc.Ref)));

// Release the hounds!
stYup.bHardwareEnable := bSTOEnable1 AND bSTOEnable2;
stYdwn.bHardwareEnable := bSTOEnable1 AND bSTOEnable2;
stXup.bHardwareEnable := bSTOEnable1 AND bSTOEnable2;
stXdwn.bHardwareEnable := bSTOEnable1 AND bSTOEnable2;
stPitch.bHardwareEnable := bSTOEnable1 AND bSTOEnable2;

// Start Autocoupling
fbAutoCoupleY(nGantryTol:=nGantryTolY,
              Master:=stYup,
              MasterEnc:= stYupEnc,
              Slave:=stYdwn,
              SlaveEnc:=stYdwnEnc,
              bExecuteCouple:=bExecuteCoupleY,
              bExecuteDecouple:=bExecuteDecoupleY,
              bGantryAlreadyCoupled=&gt;bGantryAlreadyCoupledY);

fbAutoCoupleX(nGantryTol:=nGantryTolX,
              Master:=stXup,
              MasterEnc:= stXupEnc,
              Slave:=stXdwn,
              SlaveEnc:=stXdwnEnc,
              bExecuteCouple:=bExecuteCoupleX,
              bExecuteDecouple:=bExecuteDecoupleX,
              bGantryAlreadyCoupled=&gt;bGantryAlreadyCoupledX);

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#gvl-constants">GVL_Constants</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="main">
<h2>Main<a class="headerlink" href="#main" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PROGRAM</span> <span class="n">Main</span>
<span class="n">VAR</span>
    <span class="p">(</span><span class="o">*</span>
    <span class="o">//</span> <span class="n">Test</span> <span class="n">Pitch</span> <span class="n">Control</span>
    <span class="n">fbPitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>
    <span class="n">TestPitch</span> <span class="p">:</span> <span class="n">HOMS_PitchMechanism</span> <span class="o">:=</span> <span class="p">(</span><span class="n">ReqPosLimHi</span><span class="o">:=</span><span class="mi">2000</span><span class="p">,</span>
                                        <span class="n">ReqPosLimLo</span><span class="o">:=-</span><span class="mi">2000</span><span class="p">,</span>
                                        <span class="n">diEncPosLimHi</span><span class="o">:=</span><span class="mi">10768330</span><span class="p">,</span>
                                        <span class="n">diEncPosLimLo</span><span class="o">:=</span><span class="mi">8141680</span><span class="p">);</span>
    <span class="n">M1</span> <span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">bPitchDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">*</span><span class="p">)</span>

    <span class="o">//</span> <span class="n">Test</span> <span class="n">Bender</span> <span class="n">vs</span> <span class="n">No</span> <span class="n">Bender</span>
    <span class="n">TESTWithBender</span> <span class="p">:</span> <span class="n">DUT_HOMS</span><span class="p">;</span>
    <span class="n">M1</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">M2</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">M3</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">M4</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">M5</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">M6</span> <span class="p">:</span> <span class="n">ST_MotionStage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">nEnableMode</span><span class="o">:=</span><span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">ALWAYS</span><span class="p">);</span>
    <span class="n">fbBender</span> <span class="p">:</span> <span class="n">FB_Bender</span><span class="p">;</span>

    <span class="n">fbMotionStage_m1</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage_m2</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage_m3</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage_m4</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbMotionStage_m6</span> <span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">Pitch</span> <span class="n">Control</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span><span class="p">;</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bLimitForwardEnable</span><span class="p">;</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bHardwareEnable</span><span class="p">;</span>
<span class="n">M1</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">150.0</span><span class="p">;</span>
<span class="n">fbPitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">TestPitch</span><span class="p">,</span>
               <span class="n">Stepper</span><span class="o">:=</span><span class="n">M1</span><span class="p">,</span>
               <span class="n">lrCurrentSetpoint</span><span class="o">:=</span><span class="n">M1</span><span class="o">.</span><span class="n">fPosition</span><span class="p">,</span>
               <span class="n">q_bDone</span><span class="o">=&gt;</span><span class="n">bPitchDone</span><span class="p">,</span>
               <span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">M1</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="n">THEN</span>
    <span class="n">M1</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">M1</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="o">*</span><span class="p">)</span>

<span class="o">//</span> <span class="n">Test</span> <span class="n">Bender</span> <span class="n">vs</span><span class="o">.</span> <span class="n">No</span> <span class="n">Bender</span><span class="p">:</span>
<span class="o">//</span> <span class="n">M1L0</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M1</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">M2</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M2</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M2</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">M3</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M3</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M3</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">M4</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M4</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M4</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">M5</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M5</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M5</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">M6</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M6</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">M6</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">TESTWithBender</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="p">(</span><span class="n">stYup</span><span class="o">:=</span><span class="n">M1</span><span class="p">,</span>
                         <span class="n">stYdwn</span><span class="o">:=</span><span class="n">M2</span><span class="p">,</span>
                         <span class="n">stXup</span><span class="o">:=</span><span class="n">M3</span><span class="p">,</span>
                         <span class="n">stXdwn</span><span class="o">:=</span><span class="n">M4</span><span class="p">,</span>
                         <span class="n">stPitch</span><span class="o">:=</span><span class="n">M5</span><span class="p">,</span>
                         <span class="n">nYupEncRef</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">nYdwnEncRef</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">nXupEncRef</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">nXdwnEncRef</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">bExecuteCoupleY</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bExecuteCoupleY</span><span class="p">,</span>
                         <span class="n">bExecuteCoupleX</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bExecuteCoupleX</span><span class="p">,</span>
                         <span class="n">bExecuteDecoupleY</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bExecuteDecoupleY</span><span class="p">,</span>
                         <span class="n">bExecuteDecoupleX</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bExecuteDecoupleX</span><span class="p">,</span>
                         <span class="n">bGantryAlreadyCoupledY</span><span class="o">=&gt;</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledY</span><span class="p">,</span>
                         <span class="n">bGantryAlreadyCoupledX</span><span class="o">=&gt;</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">bGantryAlreadyCoupledX</span><span class="p">,</span>
                         <span class="n">nCurrGantryY</span><span class="o">=&gt;</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">nCurrGantryY</span><span class="p">,</span>
                         <span class="n">nCurrGantryX</span><span class="o">=&gt;</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">nCurrGantryX</span><span class="p">);</span>
<span class="n">fbBender</span><span class="p">(</span><span class="n">stBender</span><span class="o">:=</span><span class="n">M6</span><span class="p">,</span>
         <span class="n">bSTOEnable1</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable1</span><span class="p">,</span>
         <span class="n">bSTOEnable2</span><span class="o">:=</span><span class="n">TESTWithBender</span><span class="o">.</span><span class="n">fbRunHOMS</span><span class="o">.</span><span class="n">bSTOEnable2</span><span class="p">);</span>

<span class="n">fbMotionStage_m1</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M1</span><span class="p">);</span>
<span class="n">fbMotionStage_m2</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M2</span><span class="p">);</span>
<span class="n">fbMotionStage_m3</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M3</span><span class="p">);</span>
<span class="n">fbMotionStage_m4</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M4</span><span class="p">);</span>
<span class="n">fbMotionStage_m6</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">M6</span><span class="p">);</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#dut-homs">DUT_HOMS</a></p></li>
<li><p><a class="reference internal" href="#fb-bender">FB_Bender</a></p></li>
<li><p><a class="reference internal" href="#fb-pitchcontrol">FB_PitchControl</a></p></li>
<li><p><a class="reference internal" href="#homs-pitchmechanism">HOMS_PitchMechanism</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="mc-smoothmover">
<h2>MC_SmoothMover<a class="headerlink" href="#mc-smoothmover" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">MC_SmoothMover</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">Axis</span>    <span class="p">:</span>       <span class="n">AXIS_REF</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">Velocity</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">ReqAbsPos</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span> <span class="o">//</span><span class="n">New</span> <span class="n">requested</span> <span class="n">position</span>
    <span class="n">Enable</span>  <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">While</span> <span class="n">true</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">accept</span> <span class="n">new</span> <span class="n">positions</span> <span class="ow">and</span> <span class="n">attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">to</span> <span class="n">them</span> <span class="k">if</span> <span class="n">they</span> <span class="n">are</span> <span class="n">different</span>
    <span class="n">Execute</span> <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span> <span class="o">//</span><span class="n">Will</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span> <span class="k">if</span> <span class="n">the</span> <span class="n">target</span> <span class="n">position</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">same</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">Done</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Busy</span>    <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">Error</span>   <span class="p">:</span>       <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">mcMoveAbsolute</span> <span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..2</span><span class="p">]</span> <span class="n">OF</span> <span class="n">MC_MoveAbsolute</span><span class="p">;</span>
    <span class="n">iI</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">imcBlockIndex</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">ReqAbsPosPrevious</span>       <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">rtExecute</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="p">(</span><span class="o">*</span> <span class="n">Smooth</span> <span class="n">Mover</span>
<span class="mi">2017</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">30</span>
<span class="n">A</span><span class="o">.</span> <span class="n">Wallace</span>

<span class="n">Enable</span> <span class="n">means</span> <span class="n">the</span> <span class="n">block</span> <span class="n">will</span> <span class="n">always</span> <span class="n">aquire</span> <span class="n">new</span> <span class="n">positions</span> <span class="k">as</span> <span class="n">they</span> <span class="n">are</span> <span class="n">updated</span><span class="o">.</span> <span class="n">Execute</span>
<span class="n">can</span> <span class="n">be</span> <span class="n">used</span> <span class="n">to</span> <span class="n">retry</span> <span class="n">a</span> <span class="n">move</span><span class="o">.</span> <span class="n">Axis</span> <span class="n">must</span> <span class="n">be</span> <span class="n">enabled</span> <span class="n">by</span> <span class="n">a</span> <span class="n">power</span> <span class="n">block</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>


<span class="n">rtExecute</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">Execute</span><span class="p">);</span>

<span class="n">IF</span> <span class="p">(</span> <span class="p">(</span><span class="n">ReqAbsPos</span> <span class="o">&lt;&gt;</span> <span class="n">ReqAbsPosPrevious</span> <span class="n">AND</span> <span class="n">Enable</span><span class="p">)</span> <span class="n">OR</span> <span class="n">rtExecute</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="n">imcBlockIndex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">imcBlockIndex</span> <span class="o">&gt;</span><span class="mi">2</span> <span class="n">THEN</span> <span class="n">imcBlockIndex</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">END_IF</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Position</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
            <span class="n">ReqAbsPosPrevious</span> <span class="o">:=</span> <span class="n">ReqAbsPos</span><span class="p">;</span>
        <span class="n">ELSIF</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">CommandAborted</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span>
                <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">THEN</span>
            <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">imcBlockIndex</span><span class="p">]</span><span class="o">.</span><span class="n">Execute</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>

<span class="n">FOR</span> <span class="n">iI</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="mi">2</span> <span class="n">DO</span>
    <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="n">iI</span><span class="p">](</span><span class="n">Axis</span> <span class="o">:=</span> <span class="n">Axis</span><span class="p">,</span> <span class="n">Velocity</span><span class="o">:=</span><span class="n">Velocity</span><span class="p">,</span> <span class="n">BufferMode</span><span class="o">:=</span><span class="n">MC_Aborting</span><span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">Error</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Error</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">S</span><span class="o">=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Done</span><span class="p">;</span>
<span class="n">Busy</span> <span class="o">:=</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span> <span class="n">OR</span> <span class="n">mcMoveAbsolute</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">Busy</span><span class="p">;</span>
<span class="n">Done</span> <span class="n">R</span><span class="o">=</span> <span class="n">Busy</span> <span class="n">OR</span> <span class="n">Error</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="test-pitchcontrol">
<h2>TEST_PitchControl<a class="headerlink" href="#test-pitchcontrol" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;call_after_init&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">TEST_PitchControl</span> <span class="n">EXTENDS</span> <span class="n">TcUnit</span><span class="o">.</span><span class="n">FB_TestSuite</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">LimitSwitches</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">LimitSwitches</span>
<span class="n">VAR_INPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fActPosition</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">bPitchDone</span> <span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbPitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>

    <span class="n">ExpertMode</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PitchManualMode</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">iStep</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">rtDone</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">tonHack</span> <span class="p">:</span> <span class="n">TON</span> <span class="o">:=</span> <span class="p">(</span><span class="n">PT</span><span class="o">:=</span><span class="n">T</span><span class="c1">#2s);</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">BwdLimPos</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">500</span><span class="p">;</span>
    <span class="n">FwdLimPos</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">;</span>

    <span class="n">ForwardTestSP</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>

<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">BwdLimPos</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">FwdLimPos</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">150.0</span><span class="p">;</span>

<span class="n">fbPitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="p">,</span>
               <span class="n">q_bDone</span><span class="o">=&gt;</span><span class="n">bPitchDone</span><span class="p">,</span>
               <span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="p">);</span>
<span class="n">rtDone</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bPitchDone</span><span class="p">);</span>

<span class="n">tonHack</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="o">=</span> <span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">);</span>


<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;PitchControlLimitSwitchTests&#39;</span><span class="p">);</span>
<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>


<span class="mi">0</span><span class="p">:</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">SP</span> <span class="n">to</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">hit</span> <span class="n">a</span> <span class="n">limit</span><span class="p">,</span> <span class="ow">and</span> <span class="n">stop</span><span class="o">.</span>
<span class="o">//</span> <span class="n">Test</span> <span class="n">failing</span><span class="p">,</span> <span class="ow">not</span> <span class="k">as</span> <span class="n">important</span> <span class="k">with</span> <span class="n">limit</span> <span class="n">switches</span> <span class="n">b</span><span class="o">/</span><span class="n">c</span> <span class="k">if</span> <span class="n">you</span> <span class="n">hit</span> <span class="n">the</span> <span class="n">limit</span> <span class="n">you</span> <span class="n">will</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">won</span><span class="s1">&#39;t be allowed to move forward until you manually reset the SP to within limits</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">ForwardTestSP</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Forward Limit Switch Stop&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">FwdLimPos</span> <span class="n">AND</span> <span class="n">rtDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

<span class="o">//</span>    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Setpoint did not reset to stopped position&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="o">=</span> <span class="n">MC_AXISSTATE_STANDSTILL</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bAllForwardEnable</span><span class="p">,</span> <span class="s1">&#39;Did not stop at forward limit&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Forward Limit Switch Stop&#39;</span><span class="p">);</span>

    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="mi">20</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">back</span> <span class="n">off</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">succeed</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">FwdLimPos</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Forward Limit BO&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

<span class="o">//</span>    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Position not at back off position&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Position not at back off position&#39;</span><span class="p">);</span>
    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Forward Limit BO&#39;</span><span class="p">);</span>

    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="mi">30</span><span class="p">:</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">SP</span> <span class="n">to</span> <span class="n">beyond</span> <span class="n">bwd</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">stop</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">ForwardTestSP</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Bwd Limit Switch Stop&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">FwdLimPos</span> <span class="n">AND</span> <span class="n">rtDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Setpoint did not reset to stopped position&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Bwd Limit Switch Stop&#39;</span><span class="p">);</span>

    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="mi">40</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">again</span> <span class="n">past</span> <span class="n">bwd</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">be</span> <span class="n">denied</span>

<span class="mi">50</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">back</span> <span class="n">off</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">succeed</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">BwdLimPos</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Bwd Limit BO&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">rtDone</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>

    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Position not at back off position&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Bwd Limit BO&#39;</span><span class="p">);</span>

    <span class="n">iStep</span> <span class="o">:=</span> <span class="mi">8000</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="mi">60</span><span class="p">:</span>

<span class="mi">8000</span><span class="p">:</span>
<span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;PitchControlLimitSwitchTests&#39;</span><span class="p">);</span>

<span class="n">END_CASE</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">StepperPiezoExchange</span>
<span class="n">VAR_INPUT</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fActPosition</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INST</span>
    <span class="n">fbPitchControl</span> <span class="p">:</span> <span class="n">FB_PitchControl</span><span class="p">;</span>

    <span class="n">ExpertMode</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">PitchManualMode</span> <span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

    <span class="n">iStep</span> <span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">BwdLimPos</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">500</span><span class="p">;</span>
    <span class="n">FwdLimPos</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">500</span><span class="p">;</span>

    <span class="n">ForwardTestSP</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fActPosition</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="p">;</span>

<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">BwdLimPos</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">&lt;</span> <span class="n">FwdLimPos</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="mf">150.0</span><span class="p">;</span>

<span class="n">fbPitchControl</span><span class="p">(</span><span class="n">Pitch</span><span class="o">:=</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="p">,</span>
               <span class="n">q_bDone</span><span class="o">=&gt;</span><span class="p">,</span>
               <span class="n">q_bBusy</span><span class="o">=&gt;</span><span class="p">);</span>


<span class="n">CASE</span> <span class="n">iStep</span> <span class="n">OF</span>


<span class="mi">0</span><span class="p">:</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">SP</span> <span class="n">to</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">hit</span> <span class="n">a</span> <span class="n">limit</span><span class="p">,</span> <span class="ow">and</span> <span class="n">stop</span><span class="o">.</span>
<span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">ForwardTestSP</span><span class="p">;</span>

<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;Forward Limit Switch Stop&#39;</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">fActPosition</span> <span class="o">&gt;</span> <span class="n">FwdLimPos</span> <span class="n">AND</span> <span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="o">=</span> <span class="n">MC_AXISSTATE_STANDSTILL</span> <span class="n">THEN</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">Status</span><span class="o">.</span><span class="n">MotionState</span> <span class="o">=</span> <span class="n">MC_AXISSTATE_STANDSTILL</span><span class="p">,</span> <span class="s1">&#39;Axis not at standstill&#39;</span><span class="p">);</span>
    <span class="n">AssertTrue</span><span class="p">(</span><span class="n">GVL_TestStructs</span><span class="o">.</span><span class="n">TestPitch_LimitSwitches</span><span class="o">.</span><span class="n">Stepper</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">=</span> <span class="n">fActPosition</span><span class="p">,</span> <span class="s1">&#39;Setpoint did not reset to stopped position&#39;</span><span class="p">);</span>

    <span class="n">TEST_FINISHED_NAMED</span><span class="p">(</span><span class="s1">&#39;Forward Limit Switch Stop&#39;</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="mi">10</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">again</span> <span class="n">past</span> <span class="n">fwd</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">be</span> <span class="n">denied</span>

<span class="mi">20</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">back</span> <span class="n">off</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">succeed</span>

<span class="mi">30</span><span class="p">:</span> <span class="o">//</span> <span class="n">Set</span> <span class="n">SP</span> <span class="n">to</span> <span class="n">beyond</span> <span class="n">bwd</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">stop</span>

<span class="mi">40</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">move</span> <span class="n">again</span> <span class="n">past</span> <span class="n">bwd</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">be</span> <span class="n">denied</span>

<span class="mi">50</span><span class="p">:</span> <span class="o">//</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">back</span> <span class="n">off</span> <span class="n">limit</span> <span class="ow">and</span> <span class="n">succeed</span>

<span class="n">END_CASE</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-pitchcontrol">FB_PitchControl</a></p></li>
<li><p><a class="reference internal" href="#gvl-teststructs">GVL_TestStructs</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="withinrange">
<h2>WithinRange<a class="headerlink" href="#withinrange" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION</span> <span class="n">WithinRange</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">ValA</span>    <span class="p">:</span>       <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">New</span> <span class="n">position</span> <span class="n">to</span> <span class="n">evaluate</span>
    <span class="n">Center</span> <span class="p">:</span>        <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Current</span> <span class="n">position</span>
    <span class="n">Range</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span> <span class="o">//</span><span class="n">Span</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">range</span>
    <span class="n">Offset</span>  <span class="p">:</span>       <span class="n">REAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">//</span><span class="n">Offset</span> <span class="kn">from</span> <span class="nn">center</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">range</span> <span class="ow">is</span> <span class="n">non</span><span class="o">-</span><span class="n">symetric</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">ValA</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">Center</span> <span class="o">+</span> <span class="n">Offset</span> <span class="o">-</span> <span class="p">(</span><span class="n">Range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="n">THEN</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSIF</span> <span class="n">ValA</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">Center</span> <span class="o">+</span> <span class="n">Offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">Range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span> <span class="n">THEN</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">ELSE</span>
    <span class="n">WithinRange</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lcls-twincat-optics_lcls_twincat_optics_plc_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>